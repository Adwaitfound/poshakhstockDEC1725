<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poshakh Stock Manager v53 (Outfits & Edits)</title>

    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. CONFIG -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand': {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            DEFAULT: '#2e7d32', // Primary Green
                            600: '#16a34a',
                            800: '#166534',
                        },
                        'outfit': {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            DEFAULT: '#7c3aed', // Violet
                            600: '#6d28d9',
                        },
                        'accent': {
                            DEFAULT: '#B47C00', // Gold
                        },
                        'dark-contrast': '#334155',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -5px rgba(0, 0, 0, 0.05)',
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
            -webkit-tap-highlight-color: transparent;
        }

        .safe-area-bottom {
            padding-bottom: calc(5rem + env(safe-area-inset-bottom));
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-enter {
            animation: slideUp 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2e7d32;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp, getDoc, updateDoc, increment, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp, getDoc, updateDoc, increment, getDocs, where
        };
        window.FIREBASE_MODULES_LOADED = true;
    </script>

    <!-- REACT -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PAPAPARSE (FOR CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- APP SCRIPT -->
    <script type="text/babel">

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDUK-H7scDD-9t_yVASmG34ypw7AlKwNTY",
            authDomain: "poshakh-stock.firebaseapp.com",
            projectId: "poshakh-stock",
            storageBucket: "poshakh-stock.firebasestorage.app",
            messagingSenderId: "97524547700",
            appId: "1:97524547700:web:08f8d39ed9be7ec75a9121"
        };

        const FABRICS_COLLECTION = 'fabrics';
        const ORDERS_COLLECTION = 'production_orders';
        const CUSTOMERS_COLLECTION = 'customers';
        const AVERAGE_SELLING_PRICE = 1200;

        // --- PRE-DEFINED USERS ---
        const ALLOWED_USERS = [
            { id: 1, name: 'Adwait', designation: 'Owner' },
            { id: 2, name: 'Avani', designation: 'Owner' },
            { id: 3, name: 'Binay', designation: 'Staff' }
        ];

        // --- ICONS ---
        const Icons = {
            Home: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Box: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
            Trend: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            Plus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Minus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M5 6L6 6L6 6"></path><line x1="15" y1="3" x2="9" y2="3"></line></svg>,
            MapPin: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
            Clipboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>,
            Truck: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>,
            CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            LogOut: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            User: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Image: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
            Camera: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
            X: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Pencil: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Scissors: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg>,
            Save: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            Database: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>,
            Table: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path></svg>,
            Download: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Info: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            Users: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            Globe: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>,
            ShoppingBag: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>,
            PieChart: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
        };

        // --- HELPERS ---
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
        });

        // 48.1 IMPROVED NUMBER CLEANER
        const cleanNumber = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            const strVal = val.toString();
            const cleaned = strVal.replace(/[^0-9.-]/g, '');
            return parseFloat(cleaned) || 0;
        };

        const getOutfitTotal = (breakdown) => Object.values(breakdown || {}).reduce((a, b) => a + (parseInt(b) || 0), 0);
        const getSafeDate = (ts) => ts?.toDate ? ts.toDate().toLocaleDateString() : 'N/A';

        const calculateOutfitMakingCost = (outfit, allItems) => {
            const stitch = parseFloat(outfit?.stitchingCost) || 0;
            let fabricCost = 0;
            const reqLength = parseFloat(outfit?.lengthRequiredPerOutfit) || 0;

            if (outfit?.parentFabricId && reqLength > 0) {
                const parent = allItems.find(f => f.id === outfit.parentFabricId);
                if (parent) {
                    fabricCost = (parseFloat(parent.costPerMeter) || 0) * reqLength;
                }
            }
            return stitch + fabricCost;
        };

        // --- MAIN APP ---
        const App = () => {
            const { useState, useEffect, useMemo, useRef } = React;
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp, getDoc, updateDoc, increment, getDocs, where } = window.firebase;

            // --- STATE ---
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userProfile, setUserProfile] = useState(null);

            const [inventoryItems, setInventoryItems] = useState([]);
            const [allOrders, setAllOrders] = useState([]);
            // Removed allCustomers state as customer DB is gone

            const [loading, setLoading] = useState(true);
            const [operationalError, setOperationalError] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [isConnected, setIsConnected] = useState(false);

            // Login State
            const [loginNameInput, setLoginNameInput] = useState('');
            const [loginError, setLoginError] = useState('');

            // UI State
            const [activeTab, setActiveTab] = useState('home');
            const [searchTerm, setSearchTerm] = useState('');
            const [inventoryFilter, setInventoryFilter] = useState('all');
            const [selectedImageUrl, setSelectedImageUrl] = useState(null);
            const [viewOrder, setViewOrder] = useState(null);
            const [viewCustomer, setViewCustomer] = useState(null);
            const [viewInventoryItem, setViewInventoryItem] = useState(null);
            const [showSheetModal, setShowSheetModal] = useState(false);

            // Financial View State
            const [financialViewMode, setFinancialViewMode] = useState('all'); // 'all' or 'month'

            // Customer Edit State
            // const [isEditingCustomer, setIsEditingCustomer] = useState(false); // Removed as customer DB is gone
            // const [tempCustomerData, setTempCustomerData] = useState({});

            // Order Edit State
            const [isEditingOrder, setIsEditingOrder] = useState(false);
            const [tempOrderData, setTempOrderData] = useState({});

            // Order UI State
            const [orderFilterStatus, setOrderFilterStatus] = useState('active');
            const [orderSort, setOrderSort] = useState('date_desc');

            // Stock Adjustment State
            const [isStockAdjusting, setIsStockAdjusting] = useState(false);
            const [adjustmentType, setAdjustmentType] = useState(null);
            const [adjustmentItemId, setAdjustmentItemId] = useState(null);
            const [adjustmentAmount, setAdjustmentAmount] = useState('');
            const [adjustmentSize, setAdjustmentSize] = useState('M');

            // Inventory Sorting State
            const [sortKey, setSortKey] = useState('name');

            // Editing
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState(null);
            const [editImageFile, setEditImageFile] = useState(null);

            // Order Processing State
            const [shippingOrderId, setShippingOrderId] = useState(null);
            const [shippingForm, setShippingForm] = useState({ sellingPrice: '', shippingCost: '', otherExpenses: '' });
            const [receivingOrderId, setReceivingOrderId] = useState(null);

            // Deletion Security State
            const [deleteOrderTargetId, setDeleteOrderTargetId] = useState(null);
            const [deletePassword, setDeletePassword] = useState('');

            // Forms
            const [addItemType, setAddItemType] = useState('fabric');
            const [newItem, setNewItem] = useState({ name: '', websiteProductName: '', totalLength: '', unit: 'meters', costPerMeter: '', lengthRequiredPerOutfit: '', parentFabricId: '', stockBreakdown: { S: 0, M: 0, L: 0, XL: 0, XXL: 0 }, location: '', stitchingCost: '', sellingPrice: '' });
            const [newImageFile, setNewImageFile] = useState(null);

            const [orderForm, setOrderForm] = useState({ orderNumber: '', fabricId: '', lengthToCut: '', outfitName: '', customerName: '', size: 'M', stitchingCost: '', acquisitionCost: '' });
            const [productionQueue, setProductionQueue] = useState([]);

            // Legacy/Manual Order State
            const [showLegacyModal, setShowLegacyModal] = useState(false);
            const [legacyForm, setLegacyForm] = useState({
                orderNumber: '', customerName: '', outfitName: '', size: 'M',
                fabricId: '', status: 'Sent to Tailor',
                sellingPrice: '', deductStock: false, cutAmount: '',
                notes: '', phone: '', address: '', discount: '', source: '', acquisitionCost: '',
                paymentMethod: 'Prepaid', codCharge: '', shippingCost: '', city: '', state: '', codRemittanceDate: ''
            });

            // Google Sheets State
            const [googleSheetId, setGoogleSheetId] = useState(localStorage.getItem('poshakhSheetId') || '');
            const [fetchedSheetData, setFetchedSheetData] = useState([]);
            const [isSheetLoading, setIsSheetLoading] = useState(false);
            const [csvPasteContent, setCsvPasteContent] = useState('');

            // Refs
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);
            const editCameraRef = useRef(null);
            const editGalleryRef = useRef(null);

            // History
            const [historyItemId, setHistoryItemId] = useState(null);
            const [transactionHistory, setTransactionHistory] = useState([]);
            const [deleteLogConfirmationId, setDeleteLogConfirmationId] = useState(null);

            // --- INIT & LISTENERS ---
            useEffect(() => {
                const storedProfile = localStorage.getItem('poshakhUserProfile');
                if (storedProfile) {
                    const profile = JSON.parse(storedProfile);
                    setUserProfile(profile);
                    if (profile.designation === 'Staff') setActiveTab('inventory');
                }
                try {
                    const app = initializeApp(FIREBASE_CONFIG);
                    const firestore = getFirestore(app);
                    const auth = getAuth(app);
                    setDb(firestore);
                    signInAnonymously(auth).catch(e => console.error(e));
                    onAuthStateChanged(auth, u => {
                        if (u) { setUserId(u.uid); }
                        setLoading(false);
                    });
                } catch (e) { setLoading(false); }
            }, []);

            useEffect(() => {
                if (!db) return;
                const unsub = onSnapshot(query(collection(db, FABRICS_COLLECTION)), (snap) => {
                    setIsConnected(true);
                    setOperationalError(null);
                    const validDocs = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(d => d && d.name);
                    setInventoryItems(validDocs.map(d => {
                        const type = d.type || 'fabric';
                        const cl = parseFloat(d.currentLength) || 0;
                        const req = parseFloat(d.lengthRequiredPerOutfit) || 1;
                        const cost = parseFloat(d.costPerMeter) || 0;
                        return {
                            ...d, type,
                            currentLength: cl, lengthRequiredPerOutfit: req, costPerMeter: cost,
                            potentialOutfits: type === 'fabric' ? Math.floor(cl / (req > 0 ? req : 1)) : 0,
                            totalCurrentCost: type === 'fabric' ? cl * cost : 0,
                            totalLength: parseFloat(d.totalLength) || 0,
                            stitchingCost: parseFloat(d.stitchingCost) || 0,
                            sellingPrice: parseFloat(d.sellingPrice) || 0,
                            parentFabricId: d.parentFabricId || '',
                            manualSoldCount: d.manualSoldCount || 0,
                            stockBreakdown: d.stockBreakdown || { S: 0, M: 0, L: 0, XL: 0, XXL: 0 }
                        };
                    }));
                }, (error) => {
                    setIsConnected(false);
                    setOperationalError(`Database Connection Error: ${error.code}. Check Rules.`);
                });
                return () => unsub();
            }, [db]);

            useEffect(() => {
                if (!db) return;
                const unsub = onSnapshot(query(collection(db, ORDERS_COLLECTION)), (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(o => o && o.orderNumber);
                    setAllOrders(list);
                });
                return () => unsub();
            }, [db]);

            // Removed Customer Collection Listener

            useEffect(() => {
                if (!db || !historyItemId) { setTransactionHistory([]); return; }
                const unsub = onSnapshot(query(collection(doc(db, FABRICS_COLLECTION, historyItemId), 'history')), (snap) => {
                    setTransactionHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.usedAt?.toMillis() || 0) - (a.usedAt?.toMillis() || 0)));
                }, (e) => console.log(e));
                return () => unsub();
            }, [db, historyItemId]);

            // --- COMPUTED DATA ---
            const soldCounts = useMemo(() => {
                const map = {};
                allOrders.forEach(o => {
                    if (o.status !== 'Cancelled') {
                        const n = (o.outfitName || '').trim();
                        if (n) map[n] = (map[n] || 0) + (parseInt(o.quantity) || 1);
                    }
                });
                return map;
            }, [allOrders]);

            const inventoryStats = useMemo(() => {
                let potentialRevenue = 0;
                let totalStockCount = 0;
                let totalFabricCostValuation = 0;
                let totalOutfitCostValuation = 0;

                inventoryItems.forEach(item => {
                    if (item.type === 'outfit') {
                        const qty = getOutfitTotal(item.stockBreakdown);
                        totalStockCount += qty;

                        // Revenue
                        potentialRevenue += qty * (item.sellingPrice || 0);

                        // Cost Valuation
                        const unitCost = calculateOutfitMakingCost(item, inventoryItems);
                        totalOutfitCostValuation += qty * unitCost;

                    } else if (item.type === 'fabric') {
                        // Cost Valuation
                        totalFabricCostValuation += (item.currentLength || 0) * (item.costPerMeter || 0);

                        // Potential Revenue (if converted to outfits)
                        // Assume average selling price of 1500 per outfit if no specific selling price
                        const sellPrice = item.sellingPrice > 0 ? item.sellingPrice : 1500;
                        potentialRevenue += (item.potentialOutfits || 0) * sellPrice;
                    }
                });

                const totalStockValuation = totalFabricCostValuation + totalOutfitCostValuation;
                const potentialProfit = potentialRevenue - totalStockValuation;
                const percentageIncrease = totalStockValuation > 0 ? (potentialProfit / totalStockValuation) * 100 : 0;

                return {
                    potentialRevenue,
                    totalStockCount,
                    totalFabricCostValuation,
                    totalOutfitCostValuation,
                    totalStockValuation,
                    percentageIncrease
                };
            }, [inventoryItems]);

            const financialMetrics = useMemo(() => {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const relevantOrders = allOrders.filter(o => {
                    if (o.status === 'Cancelled') return false;

                    if (financialViewMode === 'month') {
                        let dateObj = null;
                        if (o.createdAt?.toDate) {
                            dateObj = o.createdAt.toDate();
                        } else if (o.dateString) {
                            dateObj = new Date(o.dateString);
                        }
                        if (!dateObj || isNaN(dateObj.getTime())) return false;
                        return dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear;
                    }
                    return true;
                });

                let totalRevenue = 0;
                let totalSold = 0;
                let totalProfit = 0;
                let dailyProfit = 0;
                let totalFabricUsed = 0;

                // Expense Buckets
                let expenseFabric = 0;
                let expenseStitching = 0;
                let expenseShipping = 0;
                let expenseCOD = 0; // COD/Acquisition

                // Payment Split
                let countCOD = 0;
                let countPrepaid = 0;

                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);

                relevantOrders.forEach(order => {
                    // Cost Calculation
                    const fabric = inventoryItems.find(i => i.id === order.fabricId) || { costPerMeter: 0 };
                    const cutAmt = parseFloat(order.cutAmount) || 0;
                    const matCost = cutAmt * (parseFloat(fabric.costPerMeter) || 0);

                    const stitch = cleanNumber(order.stitchingCost);
                    const acq = cleanNumber(order.acquisitionCost) || cleanNumber(order.codCharge); // Handle both
                    const ship = cleanNumber(order.shippingCost);
                    const other = cleanNumber(order.otherExpenses);

                    const revenue = cleanNumber(order.finalSellingPrice) || cleanNumber(order.orderTotal);

                    // Only count stats if revenue exists or it's a shipped order
                    if (revenue > 0 || order.status === 'Order Shipped (Completed)') {
                        totalRevenue += revenue;
                        totalSold++;
                        totalFabricUsed += cutAmt;

                        expenseFabric += matCost;
                        expenseStitching += stitch;
                        expenseShipping += ship;
                        expenseCOD += acq + other;

                        const profit = (revenue - matCost - stitch - acq - ship - other);
                        totalProfit += profit;

                        // Daily Profit (Only if recent)
                        if (order.createdAt && typeof order.createdAt.toDate === 'function' && order.createdAt.toDate() >= todayStart) {
                            dailyProfit += profit;
                        }

                        // Payment Split
                        const method = (order.paymentMethod || '').toLowerCase();
                        if (method.includes('cod') || method.includes('cash')) countCOD++;
                        else countPrepaid++;
                    }
                });

                const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
                const revPerMeter = totalFabricUsed > 0 ? totalRevenue / totalFabricUsed : 0;
                const totalCOGS = expenseFabric + expenseStitching;

                return {
                    totalRevenue: totalRevenue.toFixed(0),
                    totalProfit: totalProfit.toFixed(0),
                    totalSold,
                    dailyProfit,
                    revPerMeter: revPerMeter.toFixed(0),
                    totalCOGS,
                    profitMargin: profitMargin.toFixed(1),
                    breakdown: {
                        fabric: expenseFabric,
                        stitch: expenseStitching,
                        ship: expenseShipping,
                        cod: expenseCOD,
                        ops: expenseCOD + expenseShipping
                    },
                    paymentSplit: { cod: countCOD, prepaid: countPrepaid }
                };
            }, [inventoryItems, allOrders, financialViewMode]);

            // --- OUTFIT PERFORMANCE LOGIC ---
            const outfitPerformanceList = useMemo(() => {
                const stats = {};

                // Iterate ALL orders to capture everything sold
                allOrders.forEach(o => {
                    if (o.status === 'Cancelled') return;
                    const name = (o.outfitName || o.productName || "Unknown").trim();
                    const revenue = cleanNumber(o.finalSellingPrice) || cleanNumber(o.orderTotal) || 0;

                    // Try to link with inventory image
                    const invItem = inventoryItems.find(i => i.name.toLowerCase() === name.toLowerCase());
                    const imageUrl = invItem?.imageUrl || o.imageUrl || `https://placehold.co/150x150/e2e8f0/64748b?text=${name.substring(0, 3)}`;

                    if (!stats[name]) stats[name] = { name, revenue: 0, qty: 0, imageUrl, stock: invItem ? getOutfitTotal(invItem.stockBreakdown) : 'N/A' };
                    stats[name].revenue += revenue;
                    stats[name].qty += (parseInt(o.quantity) || 1);
                });

                return Object.values(stats).sort((a, b) => b.revenue - a.revenue);
            }, [allOrders, inventoryItems]);

            const inventoryList = useMemo(() => {
                let list = [...inventoryItems];
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    list = list.filter(f => (f.name && f.name.toLowerCase().includes(term)) || (f.websiteProductName && f.websiteProductName.toLowerCase().includes(term)) || (f.location && f.location.toLowerCase().includes(term)));
                }
                if (inventoryFilter === 'fabrics') list = list.filter(i => i.type === 'fabric');
                if (inventoryFilter === 'outfits') list = list.filter(i => i.type === 'outfit');
                if (inventoryFilter === 'low') list = list.filter(f => f.type === 'fabric' && f.currentLength < 5);
                list.sort((a, b) => {
                    if (sortKey === 'name') return (a.name || '').localeCompare(b.name || '');
                    if (sortKey === 'stock') {
                        const stockA = a.type === 'fabric' ? a.currentLength : getOutfitTotal(a.stockBreakdown);
                        const stockB = b.type === 'fabric' ? b.currentLength : getOutfitTotal(b.stockBreakdown);
                        return stockB - stockA;
                    }
                    if (sortKey === 'potential') {
                        return (b.potentialOutfits || 0) - (a.potentialOutfits || 0);
                    }
                    return 0;
                });
                return list;
            }, [inventoryItems, searchTerm, inventoryFilter, sortKey]);

            // --- FILTERED ORDERS LOGIC ---
            const filteredOrders = useMemo(() => {
                let list = [...allOrders];

                // Hide Imported orders from main view
                list = list.filter(o => o.status !== 'Imported');

                if (orderFilterStatus === 'active') {
                    list = list.filter(o => o.status !== 'Cancelled' && o.status !== 'Order Shipped (Completed)');
                } else if (orderFilterStatus === 'completed') {
                    list = list.filter(o => o.status === 'Order Shipped (Completed)' || o.status === 'Cancelled');
                }

                list.sort((a, b) => {
                    const dateA = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                    const dateB = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                    if (orderSort === 'date_desc') return dateB - dateA;
                    if (orderSort === 'date_asc') return dateA - dateB;
                    if (orderSort === 'order_asc') return (a.orderNumber || '').localeCompare(b.orderNumber || '');
                    return 0;
                });
                return list;
            }, [allOrders, orderFilterStatus, orderSort]);

            const customerList = useMemo(() => {
                const uniqueCustomers = new Map();
                // Derived purely from orders now
                allOrders.forEach(o => {
                    if (o.customerName) {
                        const key = o.customerName.toLowerCase().trim();
                        const existing = uniqueCustomers.get(key) || {
                            name: o.customerName,
                            phone: '',
                            address: '',
                            email: '',
                            source: 'Order History',
                            customFields: o.importedData || {}
                        };

                        // Capture most recent available data
                        if (o.phone) existing.phone = o.phone;
                        if (o.address) existing.address = o.address;
                        if (o.city) existing.city = o.city;
                        if (o.state) existing.state = o.state;
                        // Map email if available from imports
                        if (o.importedData?.['Customer Email']) existing.email = o.importedData['Customer Email'];

                        uniqueCustomers.set(key, existing);
                    }
                });
                let list = Array.from(uniqueCustomers.values());
                if (searchTerm && activeTab === 'customers') {
                    const term = searchTerm.toLowerCase();
                    list = list.filter(c => c.name.toLowerCase().includes(term) || (c.phone && c.phone.includes(term)));
                }
                return list.sort((a, b) => a.name.localeCompare(b.name));
            }, [allOrders, searchTerm, activeTab]);

            const fabricOptions = useMemo(() => inventoryItems.filter(i => i.type === 'fabric' && i.currentLength > 0), [inventoryItems]);
            const outfitOptions = useMemo(() => inventoryItems.filter(i => i.type === 'outfit'), [inventoryItems]);

            // --- CUSTOMER INSIGHTS CALCULATOR ---
            const getCustomerStats = (customerName) => {
                if (!customerName) return null;
                const name = customerName.toLowerCase().trim();
                const history = allOrders.filter(o => o.customerName && o.customerName.toLowerCase().trim() === name);

                const totalSpent = history.reduce((acc, curr) => {
                    const val = cleanNumber(curr.orderTotal) || cleanNumber(curr.finalSellingPrice) || cleanNumber(curr.importedData?.['Product Price']) || 0;
                    return acc + val;
                }, 0);

                const totalItems = history.length;
                return { history, totalSpent, totalItems };
            };

            const orderViewInsights = useMemo(() => {
                if (!viewOrder) return null;
                return getCustomerStats(viewOrder.customerName);
            }, [viewOrder, allOrders]);

            const customerViewInsights = useMemo(() => {
                if (!viewCustomer) return null;
                return getCustomerStats(viewCustomer.name);
            }, [viewCustomer, allOrders]);


            // --- ACTIONS & HANDLERS ---
            const handleLogin = (e) => {
                e.preventDefault();
                const trimmedName = loginNameInput.trim();
                const user = ALLOWED_USERS.find(u => u.name.toLowerCase() === trimmedName.toLowerCase());
                if (user) {
                    const profile = { name: user.name, designation: user.designation };
                    localStorage.setItem('poshakhUserProfile', JSON.stringify(profile));
                    setUserProfile(profile);
                    setLoginError('');
                    if (user.designation === 'Staff') setActiveTab('inventory'); else setActiveTab('home');
                } else {
                    setLoginError("Invalid User Name. Access Denied.");
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('poshakhUserProfile');
                setUserProfile(null);
                setLoginNameInput('');
            };

            const handleAddToQueue = (e) => {
                e.preventDefault();
                const { orderNumber, fabricId, lengthToCut, customerName, outfitName, size, stitchingCost, acquisitionCost } = orderForm;
                let cutAmount = parseFloat(lengthToCut);
                if (isNaN(cutAmount)) cutAmount = 0;
                if (!orderNumber) { setOperationalError("Order Number is required."); return; }
                if (!fabricId && cutAmount > 0) { setOperationalError("Select a Fabric to cut from."); return; }
                const fabric = inventoryItems.find(f => f.id === fabricId);
                const item = {
                    ...orderForm,
                    fabricName: fabric?.name || 'Unknown',
                    unit: fabric?.unit || 'm',
                    cutAmount, stitchingCost: parseFloat(stitchingCost) || 0, acquisitionCost: parseFloat(acquisitionCost) || 0,
                    imageUrl: fabric?.imageUrl || ''
                };
                setProductionQueue([...productionQueue, item]);
                setOrderForm({ ...orderForm, lengthToCut: '', outfitName: '', customerName: '', stitchingCost: '', acquisitionCost: '' });
                setOperationalError(null);
            };

            const removeQueueItem = (idx) => setProductionQueue(productionQueue.filter((_, i) => i !== idx));

            const handleBatchSubmit = async () => {
                setIsUploading(true);
                try {
                    const promises = productionQueue.map(async (item) => {
                        if (item.fabricId) {
                            const fabricRef = doc(db, FABRICS_COLLECTION, item.fabricId);
                            if (item.cutAmount > 0) {
                                await updateDoc(fabricRef, { currentLength: increment(-item.cutAmount), updatedAt: serverTimestamp() });
                                await addDoc(collection(fabricRef, 'history'), { amountUsed: item.cutAmount, orderNumber: item.orderNumber, productName: item.outfitName, status: 'Sent to Tailor', type: 'CUT', usedByEmail: userProfile?.name, usedAt: serverTimestamp() });
                            }
                        }
                        await addDoc(collection(db, ORDERS_COLLECTION), {
                            fabricId: item.fabricId || '', fabricName: item.fabricName, outfitName: item.outfitName, orderNumber: item.orderNumber, customerName: item.customerName, cutAmount: item.cutAmount, unit: item.unit, size: item.size, stitchingCost: item.stitchingCost, acquisitionCost: item.acquisitionCost, imageUrl: item.imageUrl, status: 'Sent to Tailor', usedByEmail: userProfile?.name, createdAt: serverTimestamp()
                        });
                    });
                    await Promise.all(promises);
                    setProductionQueue([]);
                    setOperationalError("Batch processed!");
                    setActiveTab('orders');
                } catch (err) { setOperationalError("Batch failed: " + err.message); }
                setIsUploading(false);
            };

            // --- ORDER EDITING HANDLERS ---
            const startEditingOrder = () => {
                setTempOrderData({
                    orderNumber: viewOrder.orderNumber || '',
                    customerName: viewOrder.customerName || '',
                    outfitName: viewOrder.outfitName || '',
                    status: viewOrder.status || 'Sent to Tailor',
                    finalSellingPrice: viewOrder.finalSellingPrice || 0,
                    shippingCost: viewOrder.shippingCost || 0,
                    codCharge: viewOrder.codCharge || 0,
                    discount: viewOrder.discount || 0,
                    orderTotal: viewOrder.orderTotal || 0,
                    paymentMethod: viewOrder.paymentMethod || 'Prepaid',
                    city: viewOrder.city || viewOrder.importedData?.['Address City'] || '',
                    state: viewOrder.state || viewOrder.importedData?.['Address State'] || '',
                    codRemittanceDate: viewOrder.codRemittanceDate || ''
                });
                setIsEditingOrder(true);
            };

            const saveOrderEdit = async () => {
                if (!viewOrder?.id) return;
                setIsUploading(true);
                try {
                    const updates = {
                        orderNumber: tempOrderData.orderNumber,
                        customerName: tempOrderData.customerName,
                        outfitName: tempOrderData.outfitName,
                        status: tempOrderData.status,
                        finalSellingPrice: parseFloat(tempOrderData.finalSellingPrice) || 0,
                        shippingCost: parseFloat(tempOrderData.shippingCost) || 0,
                        codCharge: parseFloat(tempOrderData.codCharge) || 0,
                        discount: parseFloat(tempOrderData.discount) || 0,
                        orderTotal: parseFloat(tempOrderData.orderTotal) || 0,
                        paymentMethod: tempOrderData.paymentMethod,
                        city: tempOrderData.city,
                        state: tempOrderData.state,
                        codRemittanceDate: tempOrderData.codRemittanceDate,
                        updatedAt: serverTimestamp()
                    };
                    await updateDoc(doc(db, ORDERS_COLLECTION, viewOrder.id), updates);
                    setViewOrder({ ...viewOrder, ...updates });
                    setIsEditingOrder(false);
                    setOperationalError("Order record updated!");
                } catch (e) {
                    setOperationalError("Update failed: " + e.message);
                }
                setIsUploading(false);
            };

            // --- LEGACY/MANUAL SUBMIT HANDLER ---
            const handleLegacySubmit = async () => {
                setIsUploading(true);
                try {
                    const { orderNumber, customerName, outfitName, size, fabricId, status, sellingPrice, deductStock, cutAmount, notes, phone, address, discount, source, acquisitionCost, paymentMethod, city, state, codCharge, shippingCost, codRemittanceDate } = legacyForm;
                    if (!orderNumber || !customerName) throw new Error("Order # and Customer Name are required");

                    const orderData = {
                        orderNumber, customerName, outfitName, size, status, notes, phone, address, discount, source,
                        acquisitionCost: parseFloat(acquisitionCost) || 0,
                        paymentMethod: paymentMethod || 'Prepaid',
                        city: city || '',
                        state: state || '',
                        codCharge: parseFloat(codCharge) || 0,
                        shippingCost: parseFloat(shippingCost) || 0,
                        codRemittanceDate: codRemittanceDate || '',
                        usedByEmail: userProfile?.name, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                    };

                    if (fabricId) {
                        const fabric = inventoryItems.find(f => f.id === fabricId);
                        if (fabric) {
                            orderData.fabricId = fabricId; orderData.fabricName = fabric.name; orderData.imageUrl = fabric.imageUrl;
                            const cut = parseFloat(cutAmount);
                            if (deductStock && cut > 0) {
                                orderData.cutAmount = cut;
                                const fabricRef = doc(db, FABRICS_COLLECTION, fabricId);
                                await updateDoc(fabricRef, { currentLength: increment(-cut), updatedAt: serverTimestamp() });
                                await addDoc(collection(fabricRef, 'history'), { amountUsed: cut, orderNumber: orderNumber, productName: outfitName, status: 'Manual Entry', type: 'CUT', usedByEmail: userProfile?.name, usedAt: serverTimestamp() });
                            }
                        }
                    } else {
                        const linkedOutfit = inventoryItems.find(i => i.type === 'outfit' && i.name === outfitName);
                        orderData.imageUrl = linkedOutfit ? linkedOutfit.imageUrl : `https://placehold.co/150x150/e2e8f0/64748b?text=${orderNumber}`;
                    }
                    if (status === 'Order Shipped (Completed)') {
                        const finalPrice = parseFloat(sellingPrice);
                        if (finalPrice > 0) orderData.finalSellingPrice = finalPrice;
                    }

                    if (!orderData.finalSellingPrice && sellingPrice) orderData.finalSellingPrice = parseFloat(sellingPrice);

                    await addDoc(collection(db, ORDERS_COLLECTION), orderData);
                    setOperationalError("Record added successfully!");
                    setShowLegacyModal(false);
                    setLegacyForm({
                        orderNumber: '', customerName: '', outfitName: '', size: 'M',
                        fabricId: '', status: 'Sent to Tailor',
                        sellingPrice: '', deductStock: false, cutAmount: '',
                        notes: '', phone: '', address: '', discount: '', source: '', acquisitionCost: '',
                        paymentMethod: 'Prepaid', city: '', state: '', codCharge: '', shippingCost: '', codRemittanceDate: ''
                    });
                } catch (e) { setOperationalError("Error adding record: " + e.message); }
                setIsUploading(false);
            };

            // --- SHEET & IMPORT ---
            const handleFetchSheet = () => {
                if (!googleSheetId) { setOperationalError("Please enter a Google Sheet ID"); return; }
                localStorage.setItem('poshakhSheetId', googleSheetId);
                setIsSheetLoading(true);
                const url = `https://docs.google.com/spreadsheets/d/${googleSheetId}/export?format=csv`;
                Papa.parse(url, {
                    download: true, header: true,
                    complete: (results) => { setFetchedSheetData(results.data); setIsSheetLoading(false); setOperationalError(null); },
                    error: (err) => { setOperationalError("Failed to fetch. Ensure Sheet is 'Published to Web' as CSV."); setIsSheetLoading(false); }
                });
            };

            const handleParsePaste = () => {
                if (!csvPasteContent) return;
                const results = Papa.parse(csvPasteContent, { header: true });
                setFetchedSheetData(results.data);
                setOperationalError("Parsed pasted data successfully.");
            };

            // 49.1 IMPORT WITH DEEP MAPPING (v49)
            const handleImportData = async () => {
                if (!fetchedSheetData.length) return;
                setIsUploading(true);
                let newOrders = 0;
                let newOutfits = 0;

                const targetFields = ["Order Date", "Order ID", "Customer Name", "Payment Method", "Product Price", "Order Total", "Discount Value", "Tax", "Prepaid Platform", "Recieved Prepaid Date", "Prepaid Commision", "Prepaid Amount", "COD Charges", "COD Remitted Amount", "COD Remittance Date", "Freight Total Amount", "Status", "Product Name", "Channel SKU", "Master SKU", "Product Quantity", "Channel Created At", "Customer Email", "Address Line 1", "Address Line 2", "Address City", "Address State", "Address Pincode", "AWB Assigned Date", "Pickup Scheduled Date", "Order Picked Up Date", "Pickup First Attempt Date", "Pickedup Timestamp", "Order Shipped Date", "Order Delivered Date", "CRF ID", "UTR No", "Customer_invoice_id", "First_Pickup_Scheduled_Date", "Invoice Date", "Last Updated AT", "RAD Date", "timestamp", "Attempt Count", "Pickup Generated Date", "Address Score"];

                try {
                    const headerMap = {};
                    const csvHeaders = Object.keys(fetchedSheetData[0]);
                    targetFields.forEach(target => { const match = csvHeaders.find(h => h.toLowerCase() === target.toLowerCase()); if (match) headerMap[target] = match; });

                    const nameKey = headerMap['Customer Name'] || csvHeaders.find(h => ['name', 'customer', 'client', 'customer name'].includes(h.toLowerCase()));
                    const orderIdKey = headerMap['Order ID'];
                    const productKey = headerMap['Product Name'];
                    const dateKey = headerMap['Channel Created At'] || headerMap['Order Date'];
                    const totalKey = headerMap['Order Total'];

                    // Mapping Expense Keys
                    const freightKey = headerMap['Freight Total Amount'];
                    const codKey = headerMap['COD Charges'];
                    const paymentKey = headerMap['Payment Method'];

                    if (!nameKey) throw new Error("Could not find 'Customer Name' column.");

                    for (const row of fetchedSheetData) {
                        const name = row[nameKey];
                        const outfitName = productKey ? row[productKey] : 'Unknown Outfit';

                        // 1. AUTO CREATE OUTFIT
                        if (outfitName && outfitName !== 'Unknown Outfit') {
                            const outfitExists = inventoryItems.find(i => i.name.toLowerCase() === outfitName.toLowerCase());
                            if (!outfitExists) {
                                await addDoc(collection(db, FABRICS_COLLECTION), {
                                    name: outfitName,
                                    type: 'outfit',
                                    websiteProductName: row[headerMap['Channel SKU']] || '',
                                    createdAt: serverTimestamp(),
                                    stockBreakdown: { S: 0, M: 0, L: 0, XL: 0, XXL: 0 }, // Default empty stock
                                    sellingPrice: cleanNumber(row[headerMap['Product Price']]) || 0,
                                    imageUrl: `https://placehold.co/150x150/7c3aed/ffffff?text=${outfitName.substring(0, 3).toUpperCase()}`
                                });
                                newOutfits++;
                            }
                        }

                        if (name) {
                            const trimmedName = name.trim();

                            // 2. ORDER DEDUPLICATION
                            let orderExists = false;
                            const orderId = orderIdKey ? row[orderIdKey] : null;
                            const orderDate = dateKey ? row[dateKey] : '';

                            if (orderId) {
                                orderExists = allOrders.some(o => o.orderNumber === orderId);
                            } else {
                                orderExists = allOrders.some(o =>
                                    o.customerName.toLowerCase() === trimmedName.toLowerCase() &&
                                    o.outfitName === outfitName &&
                                    (o.dateString === orderDate || getSafeDate(o.createdAt) === orderDate)
                                );
                            }

                            if (!orderExists) {
                                const customFields = {};
                                targetFields.forEach(field => { if (headerMap[field]) customFields[field] = row[headerMap[field]] || ''; });

                                await addDoc(collection(db, ORDERS_COLLECTION), {
                                    orderNumber: orderId || `IMP-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                                    customerName: trimmedName,
                                    outfitName: outfitName,
                                    status: 'Imported',
                                    orderTotal: cleanNumber(row[totalKey]),
                                    finalSellingPrice: cleanNumber(row[totalKey]),

                                    // MAPPED EXPENSES
                                    shippingCost: cleanNumber(row[freightKey]),
                                    codCharge: cleanNumber(row[codKey]),
                                    paymentMethod: row[paymentKey] || 'Prepaid',
                                    quantity: parseInt(row[headerMap['Product Quantity']]) || 1,

                                    // Location
                                    city: row[headerMap['Address City']] || '',
                                    state: row[headerMap['Address State']] || '',
                                    address: [row[headerMap['Address Line 1']], row[headerMap['Address Line 2']]].filter(Boolean).join(', '),

                                    dateString: orderDate,
                                    createdAt: serverTimestamp(),
                                    importedData: customFields,
                                    imageUrl: `https://placehold.co/150x150/e2e8f0/64748b?text=Import`
                                });
                                newOrders++;
                            }
                        }
                    }
                    setOperationalError(`Sync Complete: ${newOrders} Orders, ${newOutfits} New Outfits added.`);
                    setShowSheetModal(false);
                    setActiveTab('customers');
                } catch (e) { setOperationalError("Import Error: " + e.message); }
                setIsUploading(false);
            };

            // --- GENERIC HANDLERS ---
            const handleCancelOrder = async (order) => {
                if (!confirm(`Cancel Order ${order.orderNumber}?`)) return;
                try {
                    if (order.fabricId) {
                        const fabricRef = doc(db, FABRICS_COLLECTION, order.fabricId);
                        await updateDoc(fabricRef, { currentLength: increment(order.cutAmount) });
                        await addDoc(collection(fabricRef, 'history'), { amountUsed: order.cutAmount, orderNumber: `CANCEL-${order.orderNumber}`, type: 'CANCEL_RETURN', status: 'Cancelled', usedAt: serverTimestamp() });
                    }
                    await updateDoc(doc(db, ORDERS_COLLECTION, order.id), { status: 'Cancelled', updatedAt: serverTimestamp() });
                    setOperationalError("Order Cancelled.");
                } catch (e) { setOperationalError("Cancel failed: " + e.message); }
            };

            const handleDeleteOrder = async () => {
                if (deletePassword !== 'posh123') { setOperationalError("Incorrect Password!"); return; }
                try {
                    await deleteDoc(doc(db, ORDERS_COLLECTION, deleteOrderTargetId));
                    setDeleteOrderTargetId(null); setDeletePassword('');
                    setOperationalError("Order Record Deleted.");
                } catch (e) { setOperationalError("Delete failed: " + e.message); }
            };

            const handleQuickReceive = async (orderId) => { await updateDoc(doc(db, ORDERS_COLLECTION, orderId), { status: 'Received from Tailor', updatedAt: serverTimestamp() }); };
            const openShippingModal = (orderId) => { setShippingOrderId(orderId); setShippingForm({ sellingPrice: '', shippingCost: '', otherExpenses: '' }); };
            const submitShipping = async () => {
                if (!shippingOrderId) return;
                const selling = parseFloat(shippingForm.sellingPrice);
                if (isNaN(selling) || selling <= 0) { setOperationalError("Valid selling price required."); return; }
                await updateDoc(doc(db, ORDERS_COLLECTION, shippingOrderId), {
                    status: 'Order Shipped (Completed)', finalSellingPrice: selling,
                    shippingCost: parseFloat(shippingForm.shippingCost) || 0, otherExpenses: parseFloat(shippingForm.otherExpenses) || 0,
                    updatedAt: serverTimestamp()
                });
                setShippingOrderId(null);
            };
            const handleStockAdjustmentSubmit = async (e) => { e.preventDefault(); const item = inventoryItems.find(x => x.id === adjustmentItemId); if (!item) return; const amt = parseFloat(adjustmentAmount); if (!amt || amt <= 0) return; const docRef = doc(db, FABRICS_COLLECTION, item.id); const isAdd = adjustmentType === 'ADD'; if (item.type === 'fabric') { const newLen = isAdd ? item.currentLength + amt : item.currentLength - amt; if (!isAdd && newLen < 0) { setOperationalError("Cannot deduct more than available."); return; } await updateDoc(docRef, { currentLength: newLen, updatedAt: serverTimestamp() }); await addDoc(collection(docRef, 'history'), { type: isAdd ? 'ADJUST_ADD' : 'ADJUST_DEDUCT', amountUsed: amt, isAddition: isAdd, status: 'Manual Adjustment', orderNumber: 'MANUAL', usedByEmail: userProfile?.name, usedAt: serverTimestamp() }); } else { const size = adjustmentSize; const currentQty = item.stockBreakdown?.[size] || 0; const newQty = isAdd ? currentQty + amt : currentQty - amt; if (!isAdd && newQty < 0) { setOperationalError("Cannot deduct more than available."); return; } const newBreakdown = { ...item.stockBreakdown, [size]: newQty }; await updateDoc(docRef, { stockBreakdown: newBreakdown, updatedAt: serverTimestamp() }); await addDoc(collection(docRef, 'history'), { type: isAdd ? 'OUTFIT_ADD' : 'OUTFIT_SOLD', amountUsed: amt, isAddition: isAdd, size: size, status: `Stock ${isAdd ? 'In' : 'Out'}`, orderNumber: 'MANUAL', usedByEmail: userProfile?.name, usedAt: serverTimestamp() }); } setIsStockAdjusting(false); setAdjustmentAmount(''); };
            const handleAddItem = async (e) => { e.preventDefault(); setIsUploading(true); try { let imgUrl = `https://placehold.co/150x150/${addItemType === 'fabric' ? '2e7d32' : '7c3aed'}/ffffff?text=${newItem.name.substring(0, 2).toUpperCase()}`; if (newImageFile) { const raw = await fileToBase64(newImageFile); imgUrl = raw; } const docData = { ...newItem, type: addItemType, imageUrl: imgUrl, updatedAt: serverTimestamp(), createdAt: serverTimestamp() }; if (addItemType === 'fabric') { docData.currentLength = parseFloat(newItem.totalLength); docData.lengthRequiredPerOutfit = parseFloat(newItem.lengthRequiredPerOutfit); docData.costPerMeter = parseFloat(newItem.costPerMeter); docData.totalLength = parseFloat(newItem.totalLength); docData.currentOrderStatus = 'None'; } if (addItemType === 'outfit') { docData.stitchingCost = parseFloat(newItem.stitchingCost) || 0; docData.sellingPrice = parseFloat(newItem.sellingPrice) || 0; docData.lengthRequiredPerOutfit = parseFloat(newItem.lengthRequiredPerOutfit) || 0; } await addDoc(collection(db, FABRICS_COLLECTION), docData); setNewItem({ name: '', websiteProductName: '', totalLength: '', unit: 'meters', lengthRequiredPerOutfit: '', costPerMeter: '', parentFabricId: '', stockBreakdown: { S: 0, M: 0, L: 0, XL: 0, XXL: 0 }, location: '', stitchingCost: '', sellingPrice: '' }); setNewImageFile(null); setActiveTab('inventory'); } catch (err) { setOperationalError(err.message); } setIsUploading(false); };
            const openStockModal = (item, type) => { setAdjustmentItemId(item.id); setAdjustmentType(type); setAdjustmentAmount(''); setIsStockAdjusting(true); };
            const openEditModal = (item) => { setEditForm({ id: item.id, type: item.type, name: item.name, websiteProductName: item.websiteProductName || '', location: item.location || '', costPerMeter: item.costPerMeter, lengthRequiredPerOutfit: item.lengthRequiredPerOutfit, currentLength: item.currentLength, unit: item.unit, sellingPrice: item.sellingPrice, stitchingCost: item.stitchingCost, parentFabricId: item.parentFabricId, manualSoldCount: item.manualSoldCount || 0, stockBreakdown: item.stockBreakdown || { S: 0, M: 0, L: 0, XL: 0, XXL: 0 } }); setEditImageFile(null); setEditingId(item.id); };
            const handleEditSave = async () => { if (!editForm || !db) return; setIsUploading(true); try { const docRef = doc(db, FABRICS_COLLECTION, editForm.id); const updates = { ...editForm, updatedAt: serverTimestamp() }; if (editImageFile) { const raw = await fileToBase64(editImageFile); updates.imageUrl = raw; } if (editForm.type === 'outfit') { updates.stitchingCost = parseFloat(editForm.stitchingCost) || 0; updates.sellingPrice = parseFloat(editForm.sellingPrice) || 0; updates.lengthRequiredPerOutfit = parseFloat(editForm.lengthRequiredPerOutfit) || 0; updates.manualSoldCount = parseInt(editForm.manualSoldCount) || 0; } await updateDoc(docRef, updates); setEditingId(null); } catch (e) { setOperationalError("Update Failed: " + e.message); } setIsUploading(false); };
            const handleConfirmDeleteLog = async (fid, tid) => { await deleteDoc(doc(db, FABRICS_COLLECTION, fid, 'history', tid)); setDeleteLogConfirmationId(null); }
            const getParentFabricInfo = (fabricId) => { if (!fabricId) return null; const parent = inventoryItems.find(i => i.id === fabricId); return parent ? { name: parent.name, potential: parent.potentialOutfits, id: parent.id } : null; }

            // --- RBAC: DEFINE TABS ---
            const isStaff = userProfile?.designation === 'Staff';
            const availableTabs = [
                !isStaff && { id: 'home', icon: Icons.Home },
                { id: 'inventory', icon: Icons.Box },
                { id: 'add', icon: Icons.Plus },
                { id: 'orders', icon: Icons.Clipboard },
                { id: 'outfits', icon: Icons.ShoppingBag }, // NEW TAB
                { id: 'customers', icon: Icons.Users },
            ].filter(Boolean);

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50"><div className="spinner"></div></div>;

            if (!userProfile) return <div className="min-h-screen flex items-center justify-center bg-white p-6"><div className="w-full max-w-sm"><div className="text-center mb-10"><h1 className="text-3xl font-extrabold text-brand mb-2">Poshakh Manager</h1><p className="text-gray-500 text-sm">Stock & Production Tracking</p></div><form onSubmit={handleLogin} className="space-y-5"><div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Your Name</label><div className="flex items-center border-b-2 border-gray-200 py-2 focus-within:border-brand"><Icons.User className="w-5 h-5 text-gray-400 mr-2" /><input required className="w-full bg-transparent outline-none text-gray-900 placeholder-gray-300" placeholder="Enter name" value={loginNameInput} onChange={e => setLoginNameInput(e.target.value)} /></div>{loginError && <p className="text-xs text-red-500 font-bold mt-2">{loginError}</p>}</div><button type="submit" className="w-full bg-brand text-white font-bold py-4 rounded-xl shadow-lg hover:bg-brand-800 transition-all">Enter App</button></form></div></div>;

            return (
                <div className="min-h-screen pb-24 safe-area-bottom">
                    {/* HEADER */}
                    <div className="bg-white px-6 pt-12 pb-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setOperationalError(isConnected ? 'Status: Connected' : 'Status: Disconnected')} className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></button>
                            <div><p className="text-gray-500 text-xs font-semibold uppercase tracking-wider">Good Morning</p><h1 className="text-xl font-extrabold text-brand truncate max-w-[200px]">{userProfile.name}</h1><span className="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">{userProfile.designation}</span></div>
                        </div>
                        <div className="flex gap-2">
                            {!isStaff && <button onClick={() => setShowSheetModal(true)} className="h-10 w-10 bg-green-100 text-green-700 rounded-full flex items-center justify-center hover:bg-green-200"><Icons.Table className="w-5 h-5" /></button>}
                            <button onClick={handleLogout} className="h-10 w-10 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-red-500"><Icons.LogOut className="w-5 h-5" /></button>
                        </div>
                    </div>

                    <div className="px-4 py-6 space-y-6">
                        {operationalError && <div className="p-4 bg-red-50 border-l-4 border-red-500 text-red-700 flex justify-between items-center shadow-sm rounded-r-md"><span className="text-sm font-medium">{operationalError}</span><button onClick={() => setOperationalError(null)}><Icons.X className="w-5 h-5" /></button></div>}

                        {/* --- HOME TAB --- */}
                        {activeTab === 'home' && !isStaff && (
                            <>
                                {/* VIEW TOGGLE */}
                                <div className="flex justify-end mb-4">
                                    <div className="bg-gray-100 p-1 rounded-lg flex text-xs font-bold">
                                        <button onClick={() => setFinancialViewMode('all')} className={`px-3 py-1 rounded-md ${financialViewMode === 'all' ? 'bg-white shadow text-gray-900' : 'text-gray-500'}`}>All Time</button>
                                        <button onClick={() => setFinancialViewMode('month')} className={`px-3 py-1 rounded-md ${financialViewMode === 'month' ? 'bg-white shadow text-gray-900' : 'text-gray-500'}`}>This Month</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-brand text-white p-5 rounded-3xl shadow-soft flex flex-col justify-between h-40 relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-20"><Icons.Trend className="w-12 h-12" /></div><div><h3 className="text-2xl font-bold">{parseInt(financialMetrics.totalRevenue).toLocaleString()}</h3><p className="text-brand-100 text-xs font-medium mt-1">Total Revenue</p><p className="text-[10px] text-brand-200 mt-1">{financialMetrics.totalSold} Orders</p></div></div>
                                    <div className="bg-white p-5 rounded-3xl shadow-soft flex flex-col justify-between h-40"><div><h3 className="text-2xl font-bold text-gray-900">{parseInt(financialMetrics.totalProfit).toLocaleString()}</h3><p className="text-gray-400 text-xs font-medium">Net Profit</p><div className="mt-2 text-[10px] text-gray-500 space-y-1"><p className="text-green-600 font-bold">{financialMetrics.profitMargin}% Margin</p></div></div></div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-3xl shadow-soft flex flex-col justify-center">
                                        <p className="text-xs text-gray-400 font-bold uppercase mb-1">Daily Profit</p>
                                        <p className="text-xl font-bold text-gray-800">{financialMetrics.dailyProfit.toLocaleString()}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-3xl shadow-soft flex flex-col justify-center">
                                        <p className="text-xs text-gray-400 font-bold uppercase mb-1">Rev / Meter</p>
                                        <p className="text-xl font-bold text-gray-800">{financialMetrics.revPerMeter}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-3xl shadow-soft flex flex-col justify-center">
                                        <p className="text-xs text-gray-400 font-bold uppercase mb-1">Potential Rev</p>
                                        <p className="text-xl font-bold text-gray-800">{inventoryStats.potentialRevenue.toLocaleString()}</p>
                                        <p className="text-[10px] font-bold text-green-600 mt-1">+{inventoryStats.percentageIncrease.toFixed(0)}% Potential ROI</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-3xl shadow-soft flex flex-col justify-center">
                                        <p className="text-xs text-gray-400 font-bold uppercase mb-1">Stock Value</p>
                                        <p className="text-xl font-bold text-gray-800">{inventoryStats.totalStockValuation.toLocaleString()}</p>
                                        <div className="flex gap-2 text-[9px] mt-1 text-gray-500">
                                            <span>Fab: {(inventoryStats.totalFabricCostValuation / 1000).toFixed(1)}k</span>
                                            <span>|</span>
                                            <span>Out: {(inventoryStats.totalOutfitCostValuation / 1000).toFixed(1)}k</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-3xl shadow-soft">
                                        <p className="text-xs text-gray-400 font-bold uppercase mb-1">Expenses</p>
                                        <div className="text-[10px] space-y-1">
                                            <div className="flex justify-between"><span>Fabric:</span> <span className="font-bold">{(financialMetrics.breakdown.fabric / 1000).toFixed(1)}k</span></div>
                                            <div className="flex justify-between"><span>Stitch:</span> <span className="font-bold">{(financialMetrics.breakdown.stitch / 1000).toFixed(1)}k</span></div>
                                            <div className="flex justify-between"><span>Ship:</span> <span className="font-bold">{(financialMetrics.breakdown.ship / 1000).toFixed(1)}k</span></div>
                                            <div className="flex justify-between text-orange-600"><span>COD/Acq:</span> <span className="font-bold">{(financialMetrics.breakdown.cod / 1000).toFixed(1)}k</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-3xl shadow-soft">
                                        <p className="text-xs text-gray-400 font-bold uppercase mb-1">Payment Split</p>
                                        <div className="flex items-center justify-center h-20">
                                            <div className="text-center">
                                                <p className="text-xl font-bold text-gray-800">{financialMetrics.paymentSplit.cod} <span className="text-xs font-normal text-gray-400">COD</span></p>
                                                <p className="text-xl font-bold text-gray-800">{financialMetrics.paymentSplit.prepaid} <span className="text-xs font-normal text-gray-400">Prepaid</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                        {/* --- INVENTORY TAB --- */}
                        {activeTab === 'inventory' && (
                            <div className="space-y-4 fade-in">
                                <div className="flex justify-between items-center mb-2"><h2 className="text-2xl font-bold text-gray-900">Inventory</h2><button onClick={() => setActiveTab('add')} className="text-sm bg-brand text-white px-4 py-2 rounded-full font-bold shadow-lg hover:bg-brand-800 flex items-center gap-1"><Icons.Plus className="w-4 h-4" /> Add Item</button></div>
                                <div className="flex gap-2"><div className="relative flex-1"><span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><Icons.Search className="w-5 h-5" /></span><input className="w-full pl-10 p-3 bg-white rounded-xl border-none shadow-sm text-sm" placeholder="Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div><select className="text-xs bg-white border border-gray-200 rounded-lg p-2 text-gray-600 outline-none shadow-sm" value={sortKey} onChange={e => setSortKey(e.target.value)}><option value="name">Name (A-Z)</option><option value="stock">Stock Level (High)</option><option value="potential">Potential (High)</option></select></div>
                                <div className="flex space-x-2 overflow-x-auto no-scrollbar pb-2">{['all', 'fabrics', 'outfits', 'low'].map(f => (<button key={f} onClick={() => setInventoryFilter(f)} className={`px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap capitalize transition-colors ${inventoryFilter === f ? 'bg-gray-800 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100'}`}>{f}</button>))}</div>
                                <div className="grid grid-cols-2 gap-4 p-2">{inventoryList.map(item => { const isFabric = item.type === 'fabric'; if (isFabric) { const isLow = item.currentLength > 0 && item.currentLength < 5; return (<div key={item.id} className="relative aspect-[4/5] rounded-2xl overflow-hidden shadow-md bg-white cursor-pointer" onClick={() => setViewInventoryItem(item)}><img src={item.imageUrl} className="w-full h-full object-cover" /><div className="absolute bottom-0 w-full bg-gradient-to-t from-black/80 to-transparent p-3 pt-6"><h4 className="text-white font-bold text-sm truncate">{item.name}</h4><p className="text-xs text-gray-300">{item.currentLength.toFixed(1)} {item.unit}</p></div>{isLow && <div className="absolute top-2 right-2 bg-red-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full">Low</div>}</div>); } else { const totalReady = getOutfitTotal(item.stockBreakdown); const sold = (soldCounts[item.name] || 0) + (parseInt(item.manualSoldCount) || 0); return (<div key={item.id} className="relative aspect-[4/5] rounded-2xl overflow-hidden shadow-md bg-white cursor-pointer" onClick={() => setViewInventoryItem(item)}><img src={item.imageUrl} className="w-full h-full object-cover" /><div className="absolute bottom-0 w-full bg-gradient-to-t from-black/80 to-transparent p-3 pt-6"><h4 className="text-white font-bold text-sm truncate">{item.name}</h4><p className="text-xs text-gray-300 font-bold">Stock: {totalReady} <span className="opacity-60 font-normal">| Sold: {sold}</span></p></div></div>); } })}</div>
                            </div>
                        )}

                        {/* --- OUTFITS TAB (NEW v53) --- */}
                        {activeTab === 'outfits' && (
                            <div className="space-y-6 fade-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-bold text-gray-900">Outfits Performance</h2>
                                    <div className="text-xs bg-white px-3 py-1 rounded-full shadow font-bold text-gray-500">{outfitPerformanceList.length} Items</div>
                                </div>
                                <div className="grid grid-cols-1 gap-4">
                                    {outfitPerformanceList.length > 0 ? outfitPerformanceList.map((outfit, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded-2xl shadow-card flex gap-4 items-center">
                                            <div className="w-16 h-16 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0">
                                                <img src={outfit.imageUrl} className="w-full h-full object-cover" />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h4 className="font-bold text-gray-900 text-sm truncate">{outfit.name}</h4>
                                                <p className="text-xs text-gray-500">Stock: {outfit.stock === 'N/A' ? 'N/A' : outfit.stock}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-green-600">{(outfit.revenue / 1000).toFixed(1)}k</p>
                                                <p className="text-[10px] text-gray-400 font-bold">{outfit.qty} SOLD</p>
                                            </div>
                                        </div>
                                    )) : <div className="text-center py-10 text-gray-400"><p>No sales data yet.</p></div>}
                                </div>
                            </div>
                        )}

                        {/* --- ORDERS TAB --- */}
                        {activeTab === 'orders' && (
                            <div className="space-y-6 fade-in">
                                {/* CARD 1: PRODUCTION FORM */}
                                <div className="bg-white p-5 rounded-3xl shadow-soft border-l-4 border-brand">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Scissors className="w-5 h-5 text-brand" /> Production Queue</h3>
                                        <button onClick={() => setShowLegacyModal(true)} className="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full font-bold hover:bg-gray-200 flex items-center gap-1">+ Log Past Order</button>
                                    </div>

                                    <form className="space-y-3">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div><label className="text-xs font-bold text-gray-500 uppercase">Order #</label><input className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={orderForm.orderNumber} onChange={e => setOrderForm({ ...orderForm, orderNumber: e.target.value })} placeholder="101" /></div>
                                            <div><label className="text-xs font-bold text-gray-500 uppercase">Select Fabric</label><select className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={orderForm.fabricId} onChange={e => setOrderForm({ ...orderForm, fabricId: e.target.value })}><option value="">-- Choose --</option>{fabricOptions.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select></div>
                                        </div>

                                        <div className="grid grid-cols-3 gap-3">
                                            <div className="col-span-1"><label className="text-xs font-bold text-gray-500 uppercase">Cut Amt</label><input type="number" step="0.1" className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={orderForm.lengthToCut} onChange={e => setOrderForm({ ...orderForm, lengthToCut: e.target.value })} placeholder="0.0" /></div>
                                            <div className="col-span-1"><label className="text-xs font-bold text-gray-500 uppercase">Stitching </label><input type="number" className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={orderForm.stitchingCost} onChange={e => setOrderForm({ ...orderForm, stitchingCost: e.target.value })} placeholder="0.00" /></div>
                                            <div className="col-span-1"><label className="text-xs font-bold text-gray-500 uppercase">Acq. Cost </label><input type="number" className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={orderForm.acquisitionCost} onChange={e => setOrderForm({ ...orderForm, acquisitionCost: e.target.value })} placeholder="0.00" /></div>
                                        </div>

                                        <div><label className="text-xs font-bold text-gray-500 uppercase">Target Outfit</label><input list="outfit-suggestions" className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={orderForm.outfitName} onChange={e => setOrderForm({ ...orderForm, outfitName: e.target.value })} placeholder="e.g. Mirae" /><datalist id="outfit-suggestions">{outfitOptions.map(o => <option key={o.id} value={o.name} />)}</datalist></div>

                                        {/* SIZE SELECTION */}
                                        <div>
                                            <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Target Size</label>
                                            <div className="flex bg-gray-50 p-1 rounded-xl gap-1 overflow-x-auto no-scrollbar">
                                                {['S', 'M', 'L', 'XL', 'XXL', 'Custom'].map(s => (
                                                    <button key={s} type="button" onClick={() => setOrderForm({ ...orderForm, size: s })}
                                                        className={`px-3 py-2 rounded-lg text-xs font-bold transition-all ${orderForm.size === s ? 'bg-brand text-white shadow' : 'text-gray-500 hover:bg-gray-200'}`}>
                                                        {s}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <button onClick={handleAddToQueue} className="w-full bg-gray-800 text-white py-2 rounded-xl font-bold text-sm hover:bg-gray-700">+ Add to Queue</button>
                                    </form>

                                    {/* QUEUE LIST */}
                                    {productionQueue.length > 0 && (
                                        <div className="mt-4 border-t pt-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="text-xs font-bold text-gray-500 uppercase">Pending Batch ({productionQueue.length})</h4>
                                                <button onClick={() => setProductionQueue([])} className="text-[10px] text-red-500 hover:underline">Clear All</button>
                                            </div>
                                            <div className="space-y-2 mb-4">
                                                {productionQueue.map((item, idx) => (
                                                    <div key={idx} className="flex justify-between items-center text-sm bg-gray-50 p-2 rounded-lg">
                                                        <div>
                                                            <span className="font-bold text-brand">{item.fabricName}</span>
                                                            {item.cutAmount > 0 && <span className="text-xs text-gray-500 ml-2">Cut: {item.cutAmount} {item.unit}</span>}
                                                            <p className="text-[10px] text-gray-400">#{item.orderNumber} -> {item.outfitName} ({item.size})</p>
                                                        </div>
                                                        <button onClick={() => removeQueueItem(idx)} className="text-red-400 hover:text-red-600"><Icons.X className="w-4 h-4" /></button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button onClick={handleBatchSubmit} disabled={isUploading} className="w-full bg-brand text-white py-3 rounded-xl font-bold text-sm shadow-md">
                                                {isUploading ? 'Processing...' : 'Submit Batch to Production'}
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* ORDER LIST */}
                                <div>
                                    <div className="flex justify-between items-end mb-3"><h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Clipboard className="w-5 h-5 text-accent" /> Order History</h3><div className="flex gap-2"><select className="text-xs bg-white border border-gray-200 rounded-lg p-1 text-gray-600" value={orderSort} onChange={e => setOrderSort(e.target.value)}><option value="date_desc">Newest</option><option value="date_asc">Oldest</option></select><select className="text-xs bg-white border border-gray-200 rounded-lg p-1 text-gray-600" value={orderFilterStatus} onChange={e => setOrderFilterStatus(e.target.value)}><option value="active">Active Only</option><option value="completed">Completed/Cancelled</option></select></div></div>
                                    <div className="space-y-3">
                                        {filteredOrders.map(order => (
                                            <div key={order.id} onClick={() => setViewOrder(order)} className={`bg-white p-4 rounded-2xl shadow-card flex flex-col gap-3 relative cursor-pointer active:scale-95 transition-transform ${order.status === 'Cancelled' ? 'opacity-60 grayscale' : ''}`}>
                                                {order.status !== 'Cancelled' && order.status !== 'Order Shipped (Completed)' && (<button onClick={(e) => { e.stopPropagation(); handleCancelOrder(order); }} className="absolute top-3 right-3 text-gray-300 hover:text-red-500"><Icons.X className="w-5 h-5" /></button>)}
                                                {(order.status === 'Cancelled' || order.status === 'Order Shipped (Completed)') && (<button onClick={(e) => { e.stopPropagation(); setDeleteOrderTargetId(order.id); }} className="absolute bottom-3 right-3 text-gray-300 hover:text-red-500 z-10"><Icons.Trash2 className="w-5 h-5" /></button>)}
                                                <div className="flex gap-3"><img src={order.imageUrl} className="w-14 h-14 rounded-xl bg-gray-100 object-cover" /><div><div className="flex items-center gap-2"><span className="font-mono text-brand font-bold text-sm">#{order.orderNumber}</span><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${order.status === 'Sent to Tailor' ? 'bg-yellow-100 text-yellow-700' : order.status.includes('Shipped') ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{order.status}</span></div><h4 className="font-bold text-gray-800 text-sm">{order.outfitName || 'Unspecified'} <span className="text-xs bg-gray-100 px-1 rounded ml-1 text-gray-600">Size {order.size}</span></h4><p className="text-xs text-gray-500">Stitch Cost: {order.stitchingCost || 0}</p></div></div>
                                                {order.status !== 'Cancelled' && (<div className="bg-gray-50 p-2 rounded-xl flex justify-between items-center mt-1">{order.status === 'Sent to Tailor' ? (<button onClick={(e) => { e.stopPropagation(); handleQuickReceive(order.id); }} className="text-xs font-bold text-brand hover:underline">Mark Received</button>) : order.status === 'Received from Tailor' ? (<button onClick={(e) => { e.stopPropagation(); openShippingModal(order.id); }} className="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1"><Icons.Truck className="w-3 h-3" /> Ship It</button>) : (<span className="text-[10px] text-green-600 font-bold">Done</span>)}</div>)}
                                                {(order.customerName || order.phone) && (<div className="text-[10px] text-gray-400 mt-1 border-t pt-1">{order.customerName} {order.phone && ` ${order.phone}`}</div>)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- NEW TAB: CUSTOMERS --- */}
                        {activeTab === 'customers' && (
                            <div className="space-y-6 fade-in">
                                <div className="flex justify-between items-center mb-2"><h2 className="text-2xl font-bold text-gray-900">Customers</h2><div className="text-xs text-gray-500 font-medium bg-white px-3 py-1 rounded-full shadow-sm">{customerList.length} Total</div></div>
                                <div className="relative mb-4"><span className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><Icons.Search className="w-5 h-5" /></span><input className="w-full pl-10 p-3 bg-white rounded-xl border-none shadow-sm text-sm" placeholder="Search customers..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                <div className="grid grid-cols-1 gap-3">{customerList.map((customer, idx) => { const stats = getCustomerStats(customer.name); return (<div key={idx} onClick={() => setViewCustomer(customer)} className="bg-white p-4 rounded-2xl shadow-card flex items-center justify-between cursor-pointer hover:bg-gray-50"><div className="flex items-center gap-3"><div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">{customer.name.substring(0, 2).toUpperCase()}</div><div><h4 className="font-bold text-gray-900 text-sm">{customer.name}</h4><div className="flex items-center gap-2 text-[10px] text-gray-500">{customer.phone && <span> {customer.phone}</span>}{customer.source === 'Saved' && <span className="bg-green-50 text-green-600 px-1 rounded">Imported</span>}</div></div></div><div className="text-right"><p className="text-lg font-bold text-gray-900">{stats.totalItems}</p><p className="text-[10px] text-gray-400 uppercase">Orders</p></div></div>); })}{customerList.length === 0 && <div className="text-center py-10 text-gray-400"><Icons.Users className="w-12 h-12 mx-auto mb-2 opacity-20" /><p>No customers found.</p></div>}</div>
                            </div>
                        )}

                        {/* --- ADD ITEM TAB (Hidden) --- */}
                        {activeTab === 'add' && (
                            <div className="space-y-6 fade-in">
                                <h2 className="text-2xl font-bold text-gray-900">Add New Item</h2>
                                <div className="flex bg-gray-100 p-1 rounded-xl mb-4">
                                    <button onClick={() => setAddItemType('fabric')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${addItemType === 'fabric' ? 'bg-white shadow text-brand' : 'text-gray-500'}`}>Fabric</button>
                                    <button onClick={() => setAddItemType('outfit')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${addItemType === 'outfit' ? 'bg-white shadow text-outfit-600' : 'text-gray-500'}`}>Ready Outfit</button>
                                </div>
                                <form onSubmit={handleAddItem} className="space-y-4">
                                    <div onClick={() => cameraInputRef.current.click()} className="h-40 bg-gray-100 rounded-2xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-brand transition-colors">
                                        {newImageFile ? (
                                            <div className="relative w-full h-full"><img src={URL.createObjectURL(newImageFile)} className="w-full h-full object-cover rounded-2xl" /><div className="absolute inset-0 bg-black/30 flex items-center justify-center text-white font-bold">Change Image</div></div>
                                        ) : (
                                            <><Icons.Camera className="w-8 h-8 mb-2" /><span>Tap to take photo</span></>
                                        )}
                                    </div>
                                    <input type="file" hidden ref={cameraInputRef} capture="environment" accept="image/*" onChange={e => setNewImageFile(e.target.files[0])} />

                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Item Name</label><input required className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder={addItemType === 'fabric' ? "e.g. Green Silk" : "e.g. Mirae Suit"} value={newItem.name} onChange={e => setNewItem({ ...newItem, name: e.target.value })} /></div>

                                    {addItemType === 'fabric' ? (
                                        <>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="text-xs font-bold text-gray-500 uppercase">Total Length</label><input type="number" step="0.1" required className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder="0.0" value={newItem.totalLength} onChange={e => setNewItem({ ...newItem, totalLength: e.target.value })} /></div>
                                                <div><label className="text-xs font-bold text-gray-500 uppercase">Unit</label><select className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" value={newItem.unit} onChange={e => setNewItem({ ...newItem, unit: e.target.value })}><option value="meters">Meters</option><option value="yards">Yards</option></select></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="text-xs font-bold text-gray-500 uppercase">Cost / Meter</label><input type="number" className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder="" value={newItem.costPerMeter} onChange={e => setNewItem({ ...newItem, costPerMeter: e.target.value })} /></div>
                                                <div><label className="text-xs font-bold text-gray-500 uppercase">Req / Outfit</label><input type="number" step="0.1" className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder="m" value={newItem.lengthRequiredPerOutfit} onChange={e => setNewItem({ ...newItem, lengthRequiredPerOutfit: e.target.value })} /></div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div><label className="text-xs font-bold text-gray-500 uppercase">Stitching Cost</label><input type="number" className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder="" value={newItem.stitchingCost} onChange={e => setNewItem({ ...newItem, stitchingCost: e.target.value })} /></div>
                                                <div><label className="text-xs font-bold text-gray-500 uppercase">Selling Price</label><input type="number" className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder="" value={newItem.sellingPrice} onChange={e => setNewItem({ ...newItem, sellingPrice: e.target.value })} /></div>
                                            </div>
                                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200"><p className="text-xs font-bold text-gray-500 uppercase mb-2">Initial Stock</p><div className="flex justify-between gap-1">{['S', 'M', 'L', 'XL', 'XXL'].map(s => (<div key={s}><label className="block text-[10px] text-center font-bold text-gray-400 mb-1">{s}</label><input type="number" className="w-full p-2 text-center bg-white rounded-lg border border-gray-200 text-sm" placeholder="0" value={newItem.stockBreakdown[s]} onChange={e => setNewItem({ ...newItem, stockBreakdown: { ...newItem.stockBreakdown, [s]: parseInt(e.target.value) || 0 } })} /></div>))}</div></div>
                                        </>
                                    )}

                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Location / Shelf</label><input className="w-full p-3 bg-white rounded-xl border border-gray-200 mt-1" placeholder="e.g. Shelf A2" value={newItem.location} onChange={e => setNewItem({ ...newItem, location: e.target.value })} /></div>

                                    <button type="submit" disabled={isUploading} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg mt-4 ${addItemType === 'fabric' ? 'bg-brand' : 'bg-outfit-600'}`}>{isUploading ? 'Saving...' : 'Add Item'}</button>
                                </form>
                            </div>
                        )}

                    </div>

                    {/* BOTTOM NAV */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-center z-50 safe-area-bottom shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                        {availableTabs.map((tab) => {
                            if (tab.id === 'add') return <button key={tab.id} onClick={() => setActiveTab(tab.id)} className="w-12 h-12 rounded-full flex items-center justify-center bg-brand text-white shadow-lg -mt-6 border-4 border-gray-50"><tab.icon className="w-6 h-6" /></button>
                            return <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`p-2 rounded-xl transition-colors ${activeTab === tab.id ? 'text-brand bg-brand-50' : 'text-gray-400'}`}><tab.icon className="w-6 h-6" /></button>
                        })}
                    </div>

                    {/* GOOGLE SHEET MODAL */}
                    {showSheetModal && (<div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 modal-enter backdrop-blur-sm"><div className="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl relative"><button onClick={() => setShowSheetModal(false)} className="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-500 hover:text-gray-900"><Icons.X className="w-5 h-5" /></button><h2 className="text-xl font-bold text-gray-900 mb-2 flex items-center gap-2"><Icons.Table className="w-6 h-6 text-green-600" /> Google Sheets Sync</h2><p className="text-xs text-gray-500 mb-4">Fetch data from a "Published to Web" Google Sheet (CSV) or paste data.</p><div className="flex gap-2 mb-4"><input className="flex-1 p-3 bg-gray-50 rounded-xl border-none text-sm" placeholder="Paste Google Sheet ID" value={googleSheetId} onChange={e => setGoogleSheetId(e.target.value)} /><button onClick={handleFetchSheet} className="bg-green-600 text-white px-4 rounded-xl font-bold text-sm shadow-lg hover:bg-green-700 flex items-center gap-1">{isSheetLoading ? '...' : <><Icons.Download className="w-4 h-4" /> Fetch</>}</button></div><div className="mb-4"><textarea className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-xs font-mono" rows="3" placeholder="Or paste raw CSV data here if fetch fails..." value={csvPasteContent} onChange={e => setCsvPasteContent(e.target.value)}></textarea><div className="flex gap-2 mt-2"><button onClick={handleParsePaste} className="text-xs text-brand font-bold hover:underline">1. Parse Pasted CSV</button>{fetchedSheetData.length > 0 && (<button onClick={handleImportData} className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold hover:bg-blue-200 flex items-center gap-1">{isUploading ? 'Importing...' : <><Icons.Users className="w-3 h-3" /> 2. Import Data (Orders + Customers)</>}</button>)}</div></div>{fetchedSheetData.length > 0 ? (<div className="overflow-x-auto max-h-40 border rounded-xl"><table className="w-full text-left text-xs border-collapse"><thead><tr className="bg-gray-100 text-gray-600 uppercase">{Object.keys(fetchedSheetData[0]).map(key => <th key={key} className="p-2 border-b">{key}</th>)}</tr></thead><tbody>{fetchedSheetData.slice(0, 5).map((row, i) => (<tr key={i} className="border-b hover:bg-gray-50">{Object.values(row).map((val, j) => <td key={j} className="p-2 whitespace-nowrap">{val}</td>)}</tr>))}</tbody></table><p className="text-[10px] text-gray-400 mt-1 text-center">Previewing first 5 rows</p></div>) : <div className="text-center py-6 text-gray-400"><Icons.Table className="w-8 h-8 mx-auto mb-2 opacity-20" /><p>No data loaded.</p></div>}</div></div>)}

                    {/* INVENTORY DETAIL MODAL */}
                    {viewInventoryItem && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center modal-enter backdrop-blur-sm">
                            <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl h-[85vh] sm:h-auto overflow-hidden flex flex-col shadow-2xl">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h3 className="font-bold text-lg text-gray-900 truncate pr-4">{viewInventoryItem.name}</h3>
                                    <button onClick={() => setViewInventoryItem(null)} className="bg-white p-2 rounded-full shadow-sm text-gray-500 hover:text-gray-900"><Icons.X className="w-5 h-5" /></button>
                                </div>
                                <div className="overflow-y-auto p-4 space-y-6 no-scrollbar flex-1 bg-white">
                                    <div className="relative h-48 rounded-2xl overflow-hidden">
                                        <img src={viewInventoryItem.imageUrl} className="w-full h-full object-cover" />
                                        <div className="absolute bottom-0 w-full bg-black/60 p-4 text-white flex justify-between items-end">
                                            <div>
                                                <p className="text-xs opacity-80 uppercase tracking-wide">{viewInventoryItem.type}</p>
                                                <p className="text-3xl font-bold">
                                                    {viewInventoryItem.type === 'fabric' ? viewInventoryItem.currentLength.toFixed(1) : getOutfitTotal(viewInventoryItem.stockBreakdown)}
                                                    <span className="text-lg font-normal ml-1">{viewInventoryItem.type === 'fabric' ? viewInventoryItem.unit : 'Units'}</span>
                                                </p>
                                            </div>
                                            <button onClick={() => { setViewInventoryItem(null); openEditModal(viewInventoryItem); }} className="bg-white/20 p-2 rounded-lg backdrop-blur-sm hover:bg-white/30"><Icons.Pencil className="w-5 h-5" /></button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => { setViewInventoryItem(null); openStockModal(viewInventoryItem, 'ADD'); }} className="bg-green-50 text-green-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 border border-green-100"><Icons.Plus className="w-5 h-5" /> Add Stock</button>
                                        <button onClick={() => { setViewInventoryItem(null); openStockModal(viewInventoryItem, 'DEDUCT'); }} className="bg-red-50 text-red-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 border border-red-100"><Icons.Minus className="w-5 h-5" /> Deduct</button>
                                    </div>
                                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                                        {viewInventoryItem.type === 'fabric' ? (
                                            <>
                                                <div className="flex justify-between text-sm"><span className="text-gray-500">Cost per Meter</span><span className="font-bold">{viewInventoryItem.costPerMeter}</span></div>
                                                <div className="flex justify-between text-sm"><span className="text-gray-500">Total Length</span><span className="font-bold">{viewInventoryItem.totalLength} {viewInventoryItem.unit}</span></div>
                                                <div className="flex justify-between text-sm"><span className="text-gray-500">Potential Outfits</span><span className="font-bold text-brand">~{viewInventoryItem.potentialOutfits}</span></div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="flex justify-between text-sm"><span className="text-gray-500">Selling Price</span><span className="font-bold text-green-600">{viewInventoryItem.sellingPrice}</span></div>
                                                <div className="flex justify-between text-sm"><span className="text-gray-500">Stitching Cost</span><span className="font-bold">{viewInventoryItem.stitchingCost}</span></div>

                                                {/* NEW: SOLD COUNT DISPLAY */}
                                                <div className="flex justify-between text-sm"><span className="text-gray-500">Total Sold</span><span className="font-bold">{(soldCounts[viewInventoryItem.name] || 0) + (parseInt(viewInventoryItem.manualSoldCount) || 0)} Units</span></div>

                                                <div className="pt-2 border-t border-gray-200">
                                                    <p className="text-xs font-bold text-gray-400 uppercase mb-2">Size Breakdown</p>
                                                    <div className="flex justify-between">
                                                        {Object.entries(viewInventoryItem.stockBreakdown || {}).map(([size, qty]) => (
                                                            <div key={size} className="text-center">
                                                                <span className="text-[10px] text-gray-400 block">{size}</span>
                                                                <span className={`font-bold ${qty > 0 ? 'text-gray-800' : 'text-gray-300'}`}>{qty}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                        {viewInventoryItem.location && <div className="pt-2 border-t border-gray-200 flex items-center gap-2 text-sm text-gray-500"><Icons.MapPin className="w-4 h-4" /> {viewInventoryItem.location}</div>}
                                    </div>
                                    <button onClick={() => { setViewInventoryItem(null); setHistoryItemId(viewInventoryItem.id); }} className="w-full py-3 bg-white border border-gray-200 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-50">View Transaction History</button>
                                    <button onClick={() => { if (confirm('Delete this item?')) { deleteDoc(doc(db, FABRICS_COLLECTION, viewInventoryItem.id)); setViewInventoryItem(null); } }} className="w-full py-3 text-red-500 text-sm font-bold hover:bg-red-50 rounded-xl">Delete Item</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ORDER DETAIL MODAL (NEW v53) */}
                    {viewOrder && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center modal-enter backdrop-blur-sm">
                            <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl h-[90vh] sm:h-[80vh] overflow-hidden flex flex-col shadow-2xl">

                                {/* Header */}
                                <div className="bg-gray-50 p-6 border-b border-gray-100 relative">
                                    <button onClick={() => setViewOrder(null)} className="absolute top-4 right-4 bg-white p-2 rounded-full shadow-sm text-gray-400 hover:text-gray-900 transition-colors"><Icons.X className="w-5 h-5" /></button>
                                    <div className="flex items-center gap-4">
                                        <div className="h-16 w-16 rounded-xl bg-gray-200 flex-shrink-0 overflow-hidden border-2 border-white shadow-sm">
                                            <img src={viewOrder.imageUrl} className="w-full h-full object-cover" />
                                        </div>
                                        <div>
                                            {isEditingOrder ? (
                                                <input className="font-bold text-xl text-gray-900 leading-tight bg-white border border-gray-200 rounded px-2 py-1 w-full mb-1" value={tempOrderData.customerName} onChange={e => setTempOrderData({ ...tempOrderData, customerName: e.target.value })} placeholder="Customer Name" />
                                            ) : (
                                                <h3 className="font-bold text-xl text-gray-900 leading-tight">{viewOrder.customerName || 'Unknown Customer'}</h3>
                                            )}
                                            <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Order #{isEditingOrder ? tempOrderData.orderNumber : viewOrder.orderNumber}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="overflow-y-auto p-6 space-y-6 no-scrollbar flex-1 bg-white">

                                    {isEditingOrder ? (
                                        <div className="space-y-4">
                                            {/* EDIT MODE FORM */}

                                            {/* 1. Core Info */}
                                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                                                <h4 className="text-xs font-bold text-gray-400 uppercase">Order Details</h4>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-[10px] font-bold text-gray-500 uppercase">Order Number</label>
                                                        <input className="w-full p-2 bg-white rounded border text-sm font-bold" value={tempOrderData.orderNumber} onChange={e => setTempOrderData({ ...tempOrderData, orderNumber: e.target.value })} />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-gray-500 uppercase">Status</label>
                                                        <select className="w-full p-2 bg-white rounded border text-sm" value={tempOrderData.status} onChange={e => setTempOrderData({ ...tempOrderData, status: e.target.value })}>
                                                            <option value="Sent to Tailor">Sent to Tailor</option>
                                                            <option value="Received from Tailor">Received from Tailor</option>
                                                            <option value="Order Shipped (Completed)">Order Shipped</option>
                                                            <option value="Imported">Imported</option>
                                                            <option value="Cancelled">Cancelled</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">Product Name</label>
                                                    <input list="edit-outfit-suggestions" className="w-full p-2 bg-white rounded border text-sm" value={tempOrderData.outfitName} onChange={e => setTempOrderData({ ...tempOrderData, outfitName: e.target.value })} placeholder="Select or type..." />
                                                    <datalist id="edit-outfit-suggestions">{outfitOptions.map(o => <option key={o.id} value={o.name} />)}</datalist>
                                                </div>
                                            </div>

                                            {/* 2. Location & Payment */}
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">City</label>
                                                    <input className="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm" value={tempOrderData.city} onChange={e => setTempOrderData({ ...tempOrderData, city: e.target.value })} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">State</label>
                                                    <input className="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm" value={tempOrderData.state} onChange={e => setTempOrderData({ ...tempOrderData, state: e.target.value })} />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">Payment Method</label>
                                                    <select className="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm" value={tempOrderData.paymentMethod} onChange={e => setTempOrderData({ ...tempOrderData, paymentMethod: e.target.value })}>
                                                        <option value="Prepaid">Prepaid</option>
                                                        <option value="COD">COD</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">COD Remit Date</label>
                                                    <input type="date" className="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm" value={tempOrderData.codRemittanceDate || ''} onChange={e => setTempOrderData({ ...tempOrderData, codRemittanceDate: e.target.value })} />
                                                </div>
                                            </div>

                                            {/* 3. Financials */}
                                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                                                <h4 className="text-xs font-bold text-blue-400 uppercase">Financials</h4>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-[10px] font-bold text-blue-600 uppercase">Product Price</label>
                                                        <input type="number" className="w-full p-2 bg-white rounded border text-sm font-bold" value={tempOrderData.finalSellingPrice} onChange={e => setTempOrderData({ ...tempOrderData, finalSellingPrice: e.target.value })} />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-blue-600 uppercase">Discount</label>
                                                        <input type="number" className="w-full p-2 bg-white rounded border text-sm" value={tempOrderData.discount} onChange={e => setTempOrderData({ ...tempOrderData, discount: e.target.value })} />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-blue-600 uppercase">Delivery Amt</label>
                                                        <input type="number" className="w-full p-2 bg-white rounded border text-sm" value={tempOrderData.shippingCost} onChange={e => setTempOrderData({ ...tempOrderData, shippingCost: e.target.value })} />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-blue-600 uppercase">COD Charges</label>
                                                        <input type="number" className="w-full p-2 bg-white rounded border text-sm" value={tempOrderData.codCharge} onChange={e => setTempOrderData({ ...tempOrderData, codCharge: e.target.value })} />
                                                    </div>
                                                </div>
                                                <div className="pt-2 border-t border-blue-200">
                                                    <label className="text-[10px] font-bold text-blue-800 uppercase">Order Total (Final)</label>
                                                    <input type="number" className="w-full p-2 bg-white rounded border border-blue-300 text-lg font-bold text-blue-900" value={tempOrderData.orderTotal} onChange={e => setTempOrderData({ ...tempOrderData, orderTotal: e.target.value })} />
                                                    <p className="text-[10px] text-blue-400 mt-1 text-right">Auto: {(parseFloat(tempOrderData.finalSellingPrice) || 0) + (parseFloat(tempOrderData.shippingCost) || 0) + (parseFloat(tempOrderData.codCharge) || 0) - (parseFloat(tempOrderData.discount) || 0)}</p>
                                                </div>
                                            </div>

                                            <div className="flex gap-3 pt-2">
                                                <button onClick={saveOrderEdit} className="flex-1 py-3 bg-brand text-white font-bold rounded-xl shadow-lg">Save Changes</button>
                                                <button onClick={() => setIsEditingOrder(false)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Cancel</button>
                                            </div>
                                        </div>
                                    ) : (
                                        /* VIEW MODE (Read Only) */
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-gray-50 p-3 rounded-xl">
                                                    <p className="text-[10px] font-bold text-gray-400 uppercase">Status</p>
                                                    <p className="font-bold text-gray-900">{viewOrder.status}</p>
                                                </div>
                                                <div className="bg-gray-50 p-3 rounded-xl">
                                                    <p className="text-[10px] font-bold text-gray-400 uppercase">Product</p>
                                                    <p className="font-bold text-gray-900 truncate">{viewOrder.outfitName}</p>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                                    <p className="text-[10px] font-bold text-green-600 uppercase mb-1">Order Total</p>
                                                    <p className="font-bold text-2xl text-green-700">{cleanNumber(viewOrder.orderTotal) || cleanNumber(viewOrder.finalSellingPrice) || 0}</p>
                                                    {viewOrder.paymentMethod && <span className="text-[10px] bg-green-200 text-green-800 px-2 py-0.5 rounded-full font-bold">{viewOrder.paymentMethod}</span>}
                                                </div>
                                                <div className="bg-white p-4 rounded-xl border border-gray-100 space-y-2">
                                                    <div className="flex justify-between text-xs text-gray-500"><span>Price</span> <span>{cleanNumber(viewOrder.finalSellingPrice)}</span></div>
                                                    <div className="flex justify-between text-xs text-gray-500"><span>Ship</span> <span>{cleanNumber(viewOrder.shippingCost)}</span></div>
                                                    <div className="flex justify-between text-xs text-gray-500"><span>COD</span> <span>{cleanNumber(viewOrder.codCharge)}</span></div>
                                                    {viewOrder.discount > 0 && <div className="flex justify-between text-xs text-red-500 font-bold"><span>Disc</span> <span>-{cleanNumber(viewOrder.discount)}</span></div>}
                                                </div>
                                            </div>

                                            {(viewOrder.city || viewOrder.state || viewOrder.importedData?.['Address City']) && (
                                                <div className="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-xl">
                                                    <Icons.MapPin className="w-4 h-4" />
                                                    {viewOrder.city || viewOrder.importedData?.['Address City']}, {viewOrder.state || viewOrder.importedData?.['Address State']}
                                                </div>
                                            )}

                                            {viewOrder.codRemittanceDate && (
                                                <div className="text-xs text-gray-500 bg-gray-50 p-2 rounded-lg text-center">
                                                    COD Remitted: <span className="font-bold text-gray-800">{viewOrder.codRemittanceDate}</span>
                                                </div>
                                            )}

                                            <button onClick={startEditingOrder} className="w-full py-3 bg-brand text-white font-bold rounded-xl shadow-lg">Edit Order & Financials</button>
                                        </div>
                                    )}

                                </div>
                            </div>
                        </div>
                    )}

                    {/* CUSTOMER DETAIL MODAL */}
                    {viewCustomer && (<div className="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center modal-enter backdrop-blur-sm"><div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl h-[90vh] sm:h-[80vh] overflow-hidden flex flex-col shadow-2xl"><div className="bg-gray-50 p-6 border-b border-gray-100 relative"><button onClick={() => setViewCustomer(null)} className="absolute top-4 right-4 bg-white p-2 rounded-full shadow-sm text-gray-400 hover:text-gray-900 transition-colors"><Icons.X className="w-5 h-5" /></button><div className="flex items-center gap-4"><div className="h-16 w-16 rounded-full bg-brand text-white flex items-center justify-center text-2xl font-bold shadow-lg border-4 border-white">{viewCustomer.name.substring(0, 2).toUpperCase()}</div><div><h3 className="font-bold text-xl text-gray-900 leading-tight">{viewCustomer.name}</h3><p className="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Customer Profile</p></div></div></div><div className="overflow-y-auto p-6 space-y-6 no-scrollbar flex-1 bg-white">{customerViewInsights && (<div className="grid grid-cols-3 gap-3"><div className="bg-blue-50 p-3 rounded-2xl border border-blue-100 text-center"><p className="text-2xl font-extrabold text-blue-600">{customerViewInsights.totalItems}</p><p className="text-[10px] font-bold text-blue-400 uppercase tracking-wider">Orders</p></div><div className="bg-green-50 p-3 rounded-2xl border border-green-100 text-center"><p className="text-2xl font-extrabold text-green-600">{(customerViewInsights.totalSpent / 1000).toFixed(1)}k</p><p className="text-[10px] font-bold text-green-400 uppercase tracking-wider">Spent</p></div><div className="bg-orange-50 p-3 rounded-2xl border border-orange-100 text-center"><p className="text-2xl font-extrabold text-orange-600">{customerViewInsights.totalItems > 0 ? (customerViewInsights.totalSpent / customerViewInsights.totalItems).toFixed(0) : 0}</p><p className="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Avg Val</p></div></div>)}<div className="bg-gray-50 p-5 rounded-2xl border border-gray-100 space-y-3 relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-5"><Icons.User className="w-24 h-24" /></div><div className="flex justify-between items-center mb-2"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest">Contact Information</h4></div><div className="flex items-center gap-3 text-gray-700"><div className="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400"><span className="text-xs"></span></div><span className="font-medium text-sm">{viewCustomer.phone || 'No Phone'}</span></div><div className="flex items-center gap-3 text-gray-700"><div className="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400"><span className="text-xs font-bold">@</span></div><span className="font-medium text-sm">{viewCustomer.email || 'No Email'}</span></div><div className="flex items-start gap-3 text-gray-700"><div className="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 flex-shrink-0"><Icons.MapPin className="w-4 h-4" /></div><div class="flex-1"><span className="font-medium text-sm leading-snug pt-1">{viewCustomer.address || 'No Address'}{viewCustomer.city ? `, ${viewCustomer.city}` : ''}{viewCustomer.state ? `, ${viewCustomer.state}` : ''}</span></div></div></div>{viewCustomer.customFields && Object.keys(viewCustomer.customFields).length > 0 && (<div><h4 className="text-xs font-bold text-gray-900 uppercase tracking-widest mb-3 flex items-center gap-2"><Icons.Database className="w-4 h-4 text-gray-400" /> Imported Data</h4><div className="bg-white border border-gray-200 rounded-xl overflow-hidden divide-y divide-gray-100 text-xs">{Object.entries(viewCustomer.customFields).filter(([_, val]) => val && val !== '0' && val !== '0.00').map(([key, val]) => (<div key={key} className="flex justify-between p-3 hover:bg-gray-50"><span className="text-gray-500 font-medium">{key}</span><span className="text-gray-900 font-bold text-right max-w-[60%] truncate">{val}</span></div>))}</div></div>)}{customerViewInsights && (<div><h4 className="text-xs font-bold text-gray-900 uppercase tracking-widest mb-3 flex items-center gap-2"><Icons.Clipboard className="w-4 h-4 text-gray-400" /> Order History</h4><div className="space-y-3">{customerViewInsights.history.map(hist => (<div key={hist.id} className="flex items-center gap-4 p-3 bg-white border border-gray-100 rounded-2xl shadow-sm hover:shadow-md transition-shadow cursor-pointer" onClick={() => { setViewCustomer(null); setViewOrder(hist); }}><div className="h-12 w-12 bg-gray-100 rounded-xl overflow-hidden flex-shrink-0 border border-gray-200"><img src={hist.imageUrl} className="w-full h-full object-cover" /></div><div className="flex-1 min-w-0"><h5 className="font-bold text-gray-900 text-sm truncate">{hist.outfitName}</h5><p className="text-xs text-gray-500">#{hist.orderNumber}  {getSafeDate(hist.createdAt)}</p></div><div className="text-right"><p className="font-bold text-gray-900 text-sm">{cleanNumber(hist.finalSellingPrice) || cleanNumber(hist.orderTotal) || '-'}</p><span className={`px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${hist.status.includes('Shipped') ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{hist.status === 'Order Shipped (Completed)' ? 'Shipped' : 'Active'}</span></div></div>))}{customerViewInsights.history.length === 0 && <p className="text-center text-gray-400 py-4 italic text-sm">No orders recorded yet.</p>}</div></div>)}</div></div></div>)}

                    {/* LEGACY ORDER MODAL, ADJUSTMENT MODAL, EDIT MODAL, DELETE CONFIRMATION, SHIPPING MODAL, IMAGE MODAL REMAIN UNCHANGED (INCLUDED FOR COMPLETENESS IN RUNNABLE CODE) */}
                    {showLegacyModal && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-enter overflow-y-auto"><div className="bg-white p-6 rounded-3xl w-full max-w-lg shadow-2xl relative my-10"><button onClick={() => setShowLegacyModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X className="w-6 h-6" /></button><h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"><Icons.Database className="w-5 h-5 text-brand" /> Log Past Order</h3><div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2 no-scrollbar"><div className="bg-gray-50 p-3 rounded-xl border border-gray-100"><h4 className="text-xs font-bold text-gray-400 uppercase mb-2">Customer Details</h4><div className="grid grid-cols-2 gap-3 mb-2"><input className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="Order # (Required)" value={legacyForm.orderNumber} onChange={e => setLegacyForm({ ...legacyForm, orderNumber: e.target.value })} /><input className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="Name (Required)" value={legacyForm.customerName} onChange={e => setLegacyForm({ ...legacyForm, customerName: e.target.value })} /></div><input className="w-full p-2 bg-white rounded-lg border-none text-sm mb-2" placeholder="Phone Number" value={legacyForm.phone} onChange={e => setLegacyForm({ ...legacyForm, phone: e.target.value })} /><textarea className="w-full p-2 bg-white rounded-lg border-none text-sm mb-2" rows="2" placeholder="Delivery Address" value={legacyForm.address} onChange={e => setLegacyForm({ ...legacyForm, address: e.target.value })}></textarea><div className="grid grid-cols-2 gap-3"><input className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="City" value={legacyForm.city} onChange={e => setLegacyForm({ ...legacyForm, city: e.target.value })} /><input className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="State" value={legacyForm.state} onChange={e => setLegacyForm({ ...legacyForm, state: e.target.value })} /></div></div><div><label className="text-xs font-bold text-gray-500 uppercase">Outfit / Product</label><input list="outfit-suggestions-legacy" className="w-full p-2 bg-gray-50 rounded-xl mt-1 border border-transparent focus:bg-white focus:border-brand" value={legacyForm.outfitName} onChange={e => setLegacyForm({ ...legacyForm, outfitName: e.target.value })} placeholder="Select or Type Name" /><datalist id="outfit-suggestions-legacy">{outfitOptions.map(o => <option key={o.id} value={o.name} />)}</datalist></div><div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold text-gray-500 uppercase">Size</label><select className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={legacyForm.size} onChange={e => setLegacyForm({ ...legacyForm, size: e.target.value })}>{['S', 'M', 'L', 'XL', 'XXL', 'Custom'].map(s => <option key={s} value={s}>{s}</option>)}</select></div><div><label className="text-xs font-bold text-gray-500 uppercase">Status</label><select className="w-full p-2 bg-gray-50 rounded-xl mt-1 border-none text-sm" value={legacyForm.status} onChange={e => setLegacyForm({ ...legacyForm, status: e.target.value })}><option value="Sent to Tailor">Sent to Tailor</option><option value="Received from Tailor">Received from Tailor</option><option value="Order Shipped (Completed)">Order Shipped</option></select></div></div><div className="bg-yellow-50 p-3 rounded-xl border border-yellow-100"><h4 className="text-xs font-bold text-yellow-700 uppercase mb-2">Financials & Costs</h4><div className="grid grid-cols-2 gap-3 mb-2"><input type="number" className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="Selling Price" value={legacyForm.sellingPrice} onChange={e => setLegacyForm({ ...legacyForm, sellingPrice: e.target.value })} /><input type="number" className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="Discount" value={legacyForm.discount} onChange={e => setLegacyForm({ ...legacyForm, discount: e.target.value })} /></div><div className="grid grid-cols-2 gap-3 mb-2"><input type="number" className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="Shipping Cost" value={legacyForm.shippingCost} onChange={e => setLegacyForm({ ...legacyForm, shippingCost: e.target.value })} /><input type="number" className="w-full p-2 bg-white rounded-lg border-none text-sm" placeholder="COD Charge" value={legacyForm.codCharge} onChange={e => setLegacyForm({ ...legacyForm, codCharge: e.target.value })} /></div><div className="grid grid-cols-2 gap-3 mb-2"><div className="col-span-2"><label className="text-xs font-bold text-yellow-800 uppercase block mb-1">COD Remit Date</label><input type="date" className="w-full p-2 bg-white rounded-lg border border-yellow-300 text-sm" value={legacyForm.codRemittanceDate} onChange={e => setLegacyForm({ ...legacyForm, codRemittanceDate: e.target.value })} /></div></div><div className="mb-2"><label className="text-xs font-bold text-yellow-800 uppercase block mb-1">Payment Method</label><select className="w-full p-2 bg-white rounded-lg border border-yellow-300 text-sm" value={legacyForm.paymentMethod} onChange={e => setLegacyForm({ ...legacyForm, paymentMethod: e.target.value })}><option value="Prepaid">Prepaid</option><option value="COD">COD</option></select></div><input type="number" className="w-full p-2 bg-white rounded-lg border-none text-sm mb-2" placeholder="Cost Price (Override)" value={legacyForm.acquisitionCost} onChange={e => setLegacyForm({ ...legacyForm, acquisitionCost: e.target.value })} /><input className="w-full p-2 bg-white rounded-lg border-none text-sm mb-2" placeholder="Source (e.g. In-house, Vendor X)" value={legacyForm.source} onChange={e => setLegacyForm({ ...legacyForm, source: e.target.value })} /></div><div className="bg-gray-50 p-3 rounded-xl"><div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-gray-500 uppercase flex items-center gap-1"><Icons.Box className="w-4 h-4" /> Link Fabric (Optional)</label><div className="flex items-center gap-2"><input type="checkbox" id="deductStock" className="accent-brand w-4 h-4" checked={legacyForm.deductStock} onChange={e => setLegacyForm({ ...legacyForm, deductStock: e.target.checked })} /><label htmlFor="deductStock" className="text-xs font-bold text-brand cursor-pointer">Deduct Stock?</label></div></div><select className="w-full p-2 bg-white rounded-lg border border-gray-200 text-sm mb-2" value={legacyForm.fabricId} onChange={e => setLegacyForm({ ...legacyForm, fabricId: e.target.value })}><option value="">-- No Fabric Linked --</option>{fabricOptions.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select>{legacyForm.fabricId && legacyForm.deductStock && (<input type="number" step="0.1" className="w-full p-2 bg-white rounded-lg border border-red-200 text-sm" placeholder="Amount Used (meters)" value={legacyForm.cutAmount} onChange={e => setLegacyForm({ ...legacyForm, cutAmount: e.target.value })} />)}</div><div><label className="text-xs font-bold text-gray-500 uppercase">Notes</label><textarea className="w-full p-2 bg-gray-50 rounded-xl mt-1 border border-transparent focus:bg-white focus:border-brand text-sm" rows="2" value={legacyForm.notes} onChange={e => setLegacyForm({ ...legacyForm, notes: e.target.value })}></textarea></div></div><div className="mt-4 flex gap-3"><button onClick={handleLegacySubmit} disabled={isUploading} className="flex-1 bg-brand text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">{isUploading ? 'Saving...' : 'Add Record'}</button></div></div></div>)}
                    {isStockAdjusting && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-enter"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl"><h3 className="text-lg font-bold mb-4 text-center">{adjustmentType === 'ADD' ? 'Add Stock' : 'Deduct Stock'}</h3>{inventoryItems.find(i => i.id === adjustmentItemId)?.type === 'outfit' && (<div className="flex justify-center gap-2 mb-4">{['S', 'M', 'L', 'XL', 'XXL'].map(s => (<button key={s} onClick={() => setAdjustmentSize(s)} className={`w-10 h-10 rounded-full font-bold text-sm ${adjustmentSize === s ? 'bg-outfit-600 text-white' : 'bg-gray-100 text-gray-500'}`}>{s}</button>))}</div>)}<div className="mb-4"><input type="number" step="0.1" className="w-full p-4 border-2 border-brand-100 rounded-2xl text-2xl text-center font-bold focus:border-brand outline-none" autoFocus value={adjustmentAmount} onChange={e => setAdjustmentAmount(e.target.value)} placeholder="0.0" /></div><div className="flex gap-3"><button onClick={handleStockAdjustmentSubmit} className="flex-1 bg-brand text-white py-3 rounded-xl font-bold shadow-lg shadow-brand/30">Confirm</button><button onClick={() => setIsStockAdjusting(false)} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">Cancel</button></div></div></div>)}
                    {editingId && editForm && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-enter overflow-y-auto"><div className="bg-white p-6 rounded-3xl w-full max-w-lg shadow-2xl relative my-10"><button onClick={() => setEditingId(null)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X className="w-6 h-6" /></button><h3 className="text-xl font-bold text-gray-900 mb-4">Edit Details</h3><div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2 no-scrollbar"><div><label className="text-xs font-bold text-gray-500 uppercase">Internal Name</label><input className="w-full p-2 bg-gray-50 rounded-xl mt-1 border border-transparent focus:bg-white focus:border-brand" value={editForm.name} onChange={e => setEditForm({ ...editForm, name: e.target.value })} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">Location</label><input className="w-full p-2 bg-gray-50 rounded-xl mt-1 border border-transparent focus:bg-white focus:border-brand" value={editForm.location} onChange={e => setEditForm({ ...editForm, location: e.target.value })} /></div>{editForm.type === 'outfit' ? (<div className="bg-purple-50 p-3 rounded-xl border border-purple-100"><div className="mb-3"><label className="text-xs font-bold text-purple-800 uppercase block mb-1">Linked Fabric</label><select className="w-full p-2 bg-white rounded border border-purple-200 text-sm" value={editForm.parentFabricId} onChange={e => setEditForm({ ...editForm, parentFabricId: e.target.value })}><option value="">-- No Fabric Linked --</option>{inventoryItems.filter(i => i.type === 'fabric').map(f => (<option key={f.id} value={f.id}>{f.name}</option>))}</select></div><div className="flex justify-between mb-2"><div className="w-[30%]"><label className="text-[10px] font-bold text-purple-800 uppercase">Fab Req (m)</label><input type="number" step="0.1" className="w-full p-1 bg-white rounded border border-purple-200" value={editForm.lengthRequiredPerOutfit} onChange={e => setEditForm({ ...editForm, lengthRequiredPerOutfit: e.target.value })} /></div><div className="w-[30%]"><label className="text-[10px] font-bold text-purple-800 uppercase">Stitching</label><input type="number" className="w-full p-1 bg-white rounded border border-purple-200" value={editForm.stitchingCost} onChange={e => setEditForm({ ...editForm, stitchingCost: e.target.value })} /></div><div className="w-[30%] text-right"><label className="text-[10px] font-bold text-purple-800 uppercase">Sell Price</label><input type="number" className="w-full p-1 bg-white rounded border border-purple-200 text-right" value={editForm.sellingPrice} onChange={e => setEditForm({ ...editForm, sellingPrice: e.target.value })} /></div></div><div className="pt-2 border-t border-purple-200 text-xs flex justify-between text-purple-900"><span>Raw Cost: {calculateOutfitMakingCost({ parentFabricId: editForm.parentFabricId, lengthRequiredPerOutfit: editForm.lengthRequiredPerOutfit, stitchingCost: 0 }, inventoryItems).toFixed(0)}</span><span className="font-bold">Total Make: {calculateOutfitMakingCost(editForm, inventoryItems).toFixed(0)}</span></div><div className="pt-2 border-t border-purple-200"><p className="text-xs font-bold text-purple-800 uppercase mb-2">Manual Sold Count (Legacy)</p><input type="number" className="w-full p-2 bg-white rounded border border-purple-200 text-sm" value={editForm.manualSoldCount} onChange={e => setEditForm({ ...editForm, manualSoldCount: e.target.value })} placeholder="0" /></div><div className="pt-2 border-t border-purple-200"><p className="text-xs font-bold text-purple-800 uppercase mb-2">Stock Breakdown</p><div className="flex justify-between gap-1">{Object.entries(editForm.stockBreakdown || { S: 0, M: 0, L: 0, XL: 0, XXL: 0 }).map(([size, qty]) => (<div key={size} className="text-center"><label className="block text-[10px] font-bold text-gray-400 mb-1">{size}</label><input type="number" className="w-full p-1 text-center bg-white rounded border border-purple-200 text-xs" value={qty} onChange={e => setEditForm({ ...editForm, stockBreakdown: { ...editForm.stockBreakdown, [size]: parseInt(e.target.value) || 0 } })} /></div>))}</div></div></div>) : (<div className="bg-blue-50 p-3 rounded-xl border border-blue-100"><label className="text-xs font-bold text-blue-800 uppercase flex items-center gap-1"><Icons.Box className="w-3 h-3" /> Stock Correction</label><div className="flex gap-2 mt-1"><input type="number" step="0.1" className="w-2/3 p-2 bg-white rounded-lg border border-blue-200" value={editForm.currentLength} onChange={e => setEditForm({ ...editForm, currentLength: e.target.value })} /><span className="p-2 text-blue-800 font-bold self-center">{editForm.unit}</span></div></div>)}<div><label className="text-xs font-bold text-gray-500 uppercase block mb-2">Update Image</label><div className="flex gap-2"><div onClick={() => editCameraRef.current.click()} className="flex-1 h-16 bg-gray-50 rounded-xl border-dashed border-2 border-gray-300 flex items-center justify-center text-gray-400 cursor-pointer"><Icons.Camera className="w-5 h-5" /></div><div onClick={() => editGalleryRef.current.click()} className="flex-1 h-16 bg-gray-50 rounded-xl border-dashed border-2 border-gray-300 flex items-center justify-center text-gray-400 cursor-pointer"><Icons.Image className="w-5 h-5" /></div></div><input type="file" hidden ref={editCameraRef} capture="environment" accept="image/*" onChange={e => setEditImageFile(e.target.files[0])} /><input type="file" hidden ref={editGalleryRef} accept="image/*" onChange={e => setEditImageFile(e.target.files[0])} />{editImageFile && <p className="text-xs text-green-600 font-bold mt-1 text-center">New Image Selected</p>}</div></div><div className="mt-4 flex gap-3"><button onClick={handleEditSave} disabled={isUploading} className="flex-1 bg-brand text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">{isUploading ? 'Saving...' : <><Icons.Save className="w-5 h-5" /> Save Changes</>}</button></div></div></div>)}
                    {deleteOrderTargetId && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-enter"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl"><h3 className="text-lg font-bold mb-4 text-red-600 flex items-center gap-2"><Icons.Trash2 className="w-5 h-5" /> Delete Record?</h3><p className="text-sm text-gray-600 mb-4">Enter admin password to permanently delete this order history.</p><input type="password" className="w-full p-3 border rounded-xl mb-4" placeholder="Password" value={deletePassword} onChange={e => setDeletePassword(e.target.value)} autoFocus /><div className="flex gap-3"><button onClick={handleDeleteOrder} className="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold">Delete</button><button onClick={() => { setDeleteOrderTargetId(null); setDeletePassword('') }} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">Cancel</button></div></div></div>)}
                    {shippingOrderId && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-enter"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl"><h3 className="text-lg font-bold mb-4 text-gray-900">Complete Shipping</h3><div className="space-y-3"><div><label className="text-xs font-bold text-gray-500">Final Selling Price ()</label><input type="number" className="w-full p-2 border rounded-xl mt-1" value={shippingForm.sellingPrice} onChange={e => setShippingForm({ ...shippingForm, sellingPrice: e.target.value })} autoFocus /></div><div><label className="text-xs font-bold text-gray-500">Shipping Cost ()</label><input type="number" className="w-full p-2 border rounded-xl mt-1" value={shippingForm.shippingCost} onChange={e => setShippingForm({ ...shippingForm, shippingCost: e.target.value })} /></div><div><label className="text-xs font-bold text-gray-500">Other Expenses ()</label><input type="number" className="w-full p-2 border rounded-xl mt-1" value={shippingForm.otherExpenses} onChange={e => setShippingForm({ ...shippingForm, otherExpenses: e.target.value })} /></div></div><div className="flex gap-3 mt-4"><button onClick={submitShipping} className="flex-1 bg-brand text-white py-3 rounded-xl font-bold">Confirm Ship</button><button onClick={() => setShippingOrderId(null)} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">Cancel</button></div></div></div>)}
                    {selectedImageUrl && (<div className="fixed inset-0 bg-black/95 z-[60] flex items-center justify-center p-4 backdrop-blur-sm modal-enter" onClick={() => setSelectedImageUrl(null)}><img src={selectedImageUrl} className="max-w-full max-h-[80vh] rounded-2xl shadow-2xl" /><button className="absolute top-6 right-6 text-white p-3 bg-white/20 rounded-full"><Icons.X className="w-6 h-6" /></button></div>)}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>